
#+TITLE: Emacs Configuration
#+AUTHOR: Nelson Loyola
#+STARTUP: content
#+INFOJS_OPT: view:t toc:t ltoc:t mouse:underline buttons:0 path:http://thomasf.github.io/solarized-css/org-info.min.j
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://thomasf.github.io/solarized-css/solarized-light.min.css" />
#+OPTIONS: broken-links:t
#+PROPERTY: header-args  :results silent

* Basic settings

#+begin_src emacs-lisp
(when (eq system-type 'darwin)
  (require 'ls-lisp)
  (setq ls-lisp-use-insert-directory-program nil))

(setq user-full-name "Nelson Loyola"
      user-mail-address "nloyola@gmail.com")

(setq custom-file (expand-file-name "custom.el" user-emacs-directory))
(load custom-file)

(setq comp-async-report-warnings-errors nil)

(put 'downcase-region 'disabled nil)
(put 'upcase-region 'disabled nil)
(put 'narrow-to-region 'disabled nil)
(put 'dired-find-alternate-file 'disabled nil)
(put 'erase-buffer 'disabled nil)

;; Sentences end with a single space.
(setq sentence-end-double-space nil)

;; Set the default major mode to =text-mode=. By default it's =fundamental= mode which is
;; not what we want. Also, use =text-mode= for the scratch buffer.

(setq default-major-mode 'text-mode
      initial-major-mode 'text-mode)

;; Don't scroll to middle of the page. Also, scroll line by line, without
;; scrolloff and try to keep point at the same visual place when
;; scrolling by page.
(setq-default scroll-up-aggressively 0.01 scroll-down-aggressively 0.01)
(setq redisplay-dont-pause t
      scroll-step 1
      scroll-margin 3
      scroll-conservatively 10
      scroll-preserve-screen-position t)

;; Level of decoration {1 - 3}, t = max.
(setq font-lock-maximum-decoration t)

;; For symlinks, automatically follow the link and visit the real file instead.
(setq vc-follow-symlinks nil)

;; Make searches case insensitive.
(setq-default case-fold-search t)

;; Autosave files are created between saves after a sufficient timeout in
;; the current directory for crash detection, they begin and end with
;; =#=.  Change this location to the emacs directory.
(setq auto-save-list-file-prefix "~/.emacs.d/autosave/"
      auto-save-file-name-transforms `((".*" "~/.emacs.d/autosave/" t))
      backup-directory-alist `(("." . ,(concat user-emacs-directory "autosave"))))

;;Set line wrap at column 100.
(setq-default fill-column 100)

;; Replace =yes or no= prompt with =y or n= prompt.
(fset 'yes-or-no-p 'y-or-n-p)

;; Use UTF-8 everywhere.
(setq locale-coding-system 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
(prefer-coding-system 'utf-8)

;; Use spaces instead of tabs.
(setq-default indent-tabs-mode nil)

;; Delete the region when typing, just like as we expect nowadays.
(delete-selection-mode t)

;; Highlight matches in query-replace mode.
(setq query-replace-highlight t)

;; Use visual line mode to display long lines.
(global-visual-line-mode -1)

;;Revert these files without asking.
(setq revert-without-query '(".*"))

;; Middle-clicking is nice to paste, however it should not adjust point
;; and paste at the then adjusted point.
(setq mouse-yank-at-point t)

;; Save clipboard data of other programs in the kill ring when possible.
(setq save-interprogram-paste-before-kill t)

;; Set environment variable for shells.
(setenv "PAGER" "cat")

;; Configure =next-buffer= and =previous-buffer= to only visit file
;; buffers (has to be called for each frame):
(set-frame-parameter (selected-frame) 'buffer-predicate #'buffer-file-name)

;; These are taken from
;; https://github.com/patrickt/emacs/blob/master/init.el:
(setq
 kill-whole-line t                      ; Lets C-k delete the whole line
 ;;default-directory "~/src/"             ; My code lives here
 enable-recursive-minibuffers t         ; don't freak out if I use the minibuffer twice
 sentence-end-double-space nil          ; are you kidding me
 confirm-kill-processes nil             ; don't when quitting
 )

(setq-default cursor-type 'box
              cursor-in-non-selected-windows nil)

;; Cursor Movement
(setq auto-window-vscroll nil)

;; Turn off auto-save.
(setq auto-save-default nil)

;; Don't make any backup files.
(setq make-backup-files nil)

;; Get rid of the menu bar. Tool bar and scroll bars are disabled in
;; ~init.el~..
(when (fboundp 'menu-bar-mode) (menu-bar-mode -1))

;; Turn off the blinking cursor.
(blink-cursor-mode -1)

;; Don't use dialog boxes
(setq use-dialog-box nil)

;; Don't want an audible bell.
(setq visible-bell t)

;; Display the running program and the selected buffer in the frame title.
(setq frame-title-format
      '("" invocation-name ": " (:eval (replace-regexp-in-string
                                        "^ +" "" (buffer-name)))))
;; Don't add new lines past end of file, and indicate unused lines at the
;; end of the window with a small image in the left fringe.
(setq next-line-add-newlines nil)
(setq-default indicate-empty-lines t)

;; Add =\n= to end of file if required.
(setq require-final-newline t)

;; Eshell
(setq eshell-history-size 100000)

;; Follow Buffer

(add-to-list 'auto-mode-alist '("\\.log\\'" . auto-revert-mode))

;; Don’t compact font caches during GC.
(setq inhibit-compacting-font-caches t)

;; Automatically cycle through the highlighting faces listed in
;; ~hi-lock-face-defaults~ instead of bothering the user to pick a face
;; each time.
(setq hi-lock-auto-select-face t)

;; History
(setq history-delete-duplicates t)

;; Use the directory name to make buffer names unique.
(setq uniquify-buffer-name-style 'forward)

(global-so-long-mode 1)

(setq fit-window-to-buffer-horizontally t)
(setq window-resize-pixelwise t)

(setq-default indent-tabs-mode nil)

(setq bookmark-default-file "~/.emacs.d/etc/bookmarks")

(windmove-default-keybindings 'meta)
#+end_src

* Fonts

** Main font

#+begin_src emacs-lisp

    (defvar nl/gui-fixed-font-name "FiraCode Nerd Font")
    ;;(defvar nl/gui-fixed-font-name "CaskaydiaCove Nerd Font Mono")

    ;; (defvar nl/gui-fixed-font-name "IBM Plex Mono Medium")
    ;; (defvar nl/gui-variable-font-name "DejaVu Sans")

    ;;(defvar nl/gui-variable-font-name "GoMono Nerd Font")
    (defvar nl/gui-variable-font-name "Go")

    (defconst nl/gui-fixed-font-size-normal "10")
    (defconst nl/gui-fixed-font-size-large "18")

    (defconst nl/gui-variable-font-size-normal "12")
    (defconst nl/gui-variable-font-size-large "18")

    (defvar nl/gui-current-fixed-font-size nl/gui-fixed-font-size-normal)
    (defvar nl/gui-current-variable-font-size nl/gui-variable-font-size-normal)

    (defun nl/gui-font (font-name font-size)
      (concat font-name "-" font-size))

    (defun nl/gui-fixed-font-normal ()
      (nl/gui-font nl/gui-fixed-font-name nl/gui-fixed-font-size-normal))

    (defun nl/gui-fixed-font-large ()
      (nl/gui-font nl/gui-fixed-font-name nl/gui-fixed-font-size-large))

    (defun nl/gui-variable-font-normal ()
      (nl/gui-font nl/gui-variable-font-name nl/gui-variable-font-size-normal))

    (defun nl/gui-variable-font-large ()
      (nl/gui-font nl/gui-variable-font-name nl/gui-variable-font-size-large))

    (defun nl/set-fonts (frame)
      "Set the desired fonts for a frame. FRAME can be nil."
      (let ((fixed-font (nl/gui-fixed-font-normal)))
        (set-face-font 'default fixed-font)
        (set-face-font 'fixed-pitch fixed-font))
      (set-face-font 'variable-pitch (nl/gui-variable-font-normal))
      (set-face-attribute 'font-lock-comment-face nil :weight 'semi-bold :slant 'italic)
      ;;(set-face-background 'region (doom-darken 'green 0.2))

      (when frame
        ;;(set-face-attribute 'default frame :font nl/gui-fixed-font-name)
        (set-face-attribute 'italic frame :font nl/gui-fixed-font-name :weight 'normal :slant 'italic)
        (set-face-attribute 'bold frame :font nl/gui-fixed-font-name :weight 'bold :weight 'normal)
        (set-face-attribute 'bold-italic frame :font nl/gui-fixed-font-name :weight 'bold :slant 'italic)
        (set-fontset-font "fontset-default" nil (font-spec :size 20 :name "Fira Code Retina"))
        )

      (set-face-font 'mode-line (nl/gui-variable-font-normal))
      (set-face-font 'mode-line-buffer-id (nl/gui-variable-font-normal))
      (set-face-font 'mode-line-emphasis (nl/gui-variable-font-normal))
      (set-face-font 'mode-line-highlight (nl/gui-variable-font-normal))
      (set-face-font 'mode-line-inactive (nl/gui-variable-font-normal))
      )
#+end_src

** Change font size

#+begin_src emacs-lisp
(defhydra hydra-zoom (global-map "C-c z")
  "zoom"
  ("g" text-scale-increase "in")
  ("l" text-scale-decrease "out"))
#+end_src

Taken from: http://doc.rix.si/org/fsem.html

#+begin_src emacs-lisp
(defun nl/change-font-size (fixed-font-size variable-font-size)
  "Change font size in all buffers."
  (interactive)
  (setq nl/gui-current-fixed-font-size fixed-font-size
        nl/gui-current-variable-font-size variable-font-size)
  (let* ((frame (selected-frame))
         (fixed-font (nl/gui-font nl/gui-fixed-font-name fixed-font-size))
         (variable-font (nl/gui-font nl/gui-variable-font-name variable-font-size)))

    (set-face-attribute 'default frame :font fixed-font)
    (set-face-font 'default fixed-font)
    (set-face-font 'italic variable-font)
    (set-face-font 'bold-italic variable-font)
    (set-face-font 'fixed-pitch-serif variable-font)
    (set-face-font 'variable-pitch variable-font)

    (nl/org-mode-faces (* 10 (string-to-number fixed-font-size)))))

(defun nl/zoom-config ()
  "Set a large enough font size for all Emacs frames for screensharing on Zoom meetings."
  (interactive)
  (nl/change-font-size "16" "18"))

(defun nl/normal-config ()
  "Set the size and position of the Emacs window."
  (interactive)
  (nl/change-font-size nl/gui-fixed-font-size-normal nl/gui-variable-font-size-normal)
  (nl/main-frame-set-size-and-position))
#+end_src

* Frame configuration

#+begin_src emacs-lisp

    (defun nl/after-make-frame (frame)
      ;; disable the toolbar when in daemon mode
      ;;
      ;; https://emacs.stackexchange.com/questions/39359/tool-bar-in-emacsclient
      (unless frame
        (setq frame (selected-frame)))
      (when frame
        (with-selected-frame frame
          (when (display-graphic-p)
            (tool-bar-mode -1)
            (nl/set-fonts frame)
            ))))

    (add-hook 'after-make-frame-functions 'nl/after-make-frame t)

    (use-package emacs
      :hook
      ;; Make completion buffers disappear after 15 seconds.
      (completion-setup . (lambda ()
                            (run-at-time 15 nil
                                         (lambda ()
                                           (delete-windows-on "*Completions*")))))

      ;; Remove trailing whitespace
      (before-save . delete-trailing-whitespace)
      :bind
      ("C-z" . nil)     ;; I never want to suspend the frame
      )

#+end_src

* My functions

#+begin_src emacs-lisp
    (defun nl/kill-this-buffer ()
      "Kill the current buffer."
      (interactive)
      (kill-buffer (current-buffer)))

    (defun nl/consult-compile ()
      "Use Consult to choose a compile command."
      (interactive)
      (let ((selected-command
             (completing-read "Select a compile command: " compile-history)))
        ;; move this command to the front of the history
        (setq compile-history (remove selected-command compile-history))
        (add-to-list 'compile-history selected-command)
        (compile selected-command)))

    (defun nl/consult-async-shell-command ()
      (interactive)
      (let ((selected-command
             (completing-read "Select a shell command: " shell-command-history)))
        (async-shell-command selected-command)))

    ;; (defun nl/counsel-git-files ()
    ;;   (interactive)
    ;;   (let ((counsel-fzf-cmd "git ls-files | fzf -f \"%s\""))
    ;;     (counsel-fzf)))

(defun nl/beginning-of-line-or-indentation ()
  "move to beginning of line, or indentation"
  (interactive)
  (if (bolp)
      (back-to-indentation)
    (beginning-of-line)))

#+end_src

** Windows

#+begin_src emacs-lisp
(setq split-height-threshold 160
      split-width-threshold nil)

(defun nl/zoom-into-window ()
  "Removes all other windows but the one the point is at."
  (interactive)
  (while (> (length (window-list)) 1)
    (delete-other-windows)))

(defun nl/split-window-same-file ()
  "Splits the frame into two windows, with the buffer on the rightmost window in left and right windows."
  (interactive)
  (nl/zoom-into-window)
  (split-window-right)
  (windmove-right))

(global-set-key [f9] 'nl/zoom-into-window)
(global-set-key [S-f9] 'nl/split-window-same-file)
#+end_src

** Side windows

#+begin_src emacs-lisp

    (defvar nl/side-window-parameters
      '(window-parameters . ((no-other-window . nil)
                             (no-delete-other-windows . t))))

    ;; (setq display-buffer-alist '())

    ;; (defun nl/display-buffer-debug(buf-name action)
    ;;   (message "%s" buf-name)
    ;;   (numberp (string-match "\\(?:\\*\\(?:[Hh]elp\\|grep\\|Warnings\\|Completions\\|xref\\)\\)\\*\\)\\|\\(?:\\(?:HELM.*\\|helm.*\\)\\)" buf-name)))

    (add-to-list 'display-buffer-alist
                 '("\\(?:\\*\\(?:grep\\|Find\\|Warnings\\|xref\\)\\*\\)\\|\\(?:\\(?:HELM.*\\|helm.*\\)\\)"
                   display-buffer-in-side-window
                   (window-height . 0.15)
                   (side . bottom)
                   (slot . -1) ;; left side
                   (preserve-size . (nil . t))
                   ,nl/side-window-parameters))

    (add-to-list 'display-buffer-alist
                 '("\\*\\(?:[Hh]elp\\|Backtrace\\|Warnings\\|Completions\\|Compile-Log\\|\\*Flycheck.*\\|shell\\|compilation\\|ng-compile\\|ng-test\\|tide-references\\|sbt\\|coverlay-stats\\)\\*"
                   display-buffer-in-side-window
                   (window-height . 0.15)
                   (side . bottom)
                   (slot . 1) ;; right side
                   (preserve-size . (nil . t))
                   ,nl/side-window-parameters))

#+end_src

* Key bindings

#+begin_src emacs-lisp
    (global-set-key (kbd "M-%")           'query-replace-regexp)
    ;;(global-set-key "\C-x\C-e"          'compile)
    (global-set-key (kbd "C-S-s")         'isearch-forward)
    (global-set-key (kbd "C-x C-n")       'next-error)
    (global-set-key (kbd "C-x k")         'nl/kill-this-buffer)
    (global-set-key (kbd "M-f")           'forward-to-word)
    (global-set-key (kbd "M-B")           'backward-to-word)

    (global-set-key (kbd "<f1>")          'indent-for-tab-command)
    (global-set-key (kbd "S-<f1>")        'indent-region)
    (global-set-key (kbd "<f2>")          '(lambda () (interactive) (save-some-buffers t)))
    (global-set-key (kbd "S-<f2>")        '(lambda () (interactive) (revert-buffer t t)))
    ;;(global-set-key (kbd "S-<f3>")        'helm-projectile-rg)
    ;;(global-set-key (kbd "M-S-<f3>")      'counsel-rg)
    (global-set-key [f5]                  'nl/consult-compile)
    (global-set-key (kbd "S-<f5>")        'toggle-truncate-lines)
    (global-set-key (kbd "<f8>")          'window-toggle-side-windows)
    (global-set-key (kbd "S-<f11>")       'eval-region)
    (global-set-key (kbd "C-S-<f11>")     'align-regexp)
    ;;(global-set-key (kbd "C-c o")         'nl/counsel-git-files)

    (global-set-key (kbd "<home>")     'nl/beginning-of-line-or-indentation)

#+end_src

* Theme

#+begin_src emacs-lisp
(use-package doom-themes
      :demand t
      :config
      ;; Global settings (defaults)
      (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
            doom-themes-enable-italic t) ; if nil, italics is universally disabled

      (load-theme 'doom-acario-dark t)

      ;; Enable flashing mode-line on errors
      (doom-themes-visual-bell-config)

      ;; or for treemacs users
      ;;(setq doom-themes-treemacs-theme "doom-colors") ; use the colorful treemacs theme
      (doom-themes-treemacs-config)

      ;; Corrects (and improves) org-mode's native fontification.
      (doom-themes-org-config)
      :custom-face
      ;;(ansi-color-blue ((t (:foreground "#4f57f9"))))
      (ansi-color-blue ((t (:foreground "DeepSkyBlue1"))))
      ;;(lsp-face-highlight-read ((t (:foreground "DeepSkyBlue1"))))
      )

    (with-eval-after-load 'markdown-mode
      (set-face-background 'markdown-code-face "#121212")
      ;;(set-face-foreground 'markdown-code-face (doom-darken 'green 0.2))
      ;;(set-face-background 'org-block (doom-color 'brightblack))
      (set-face-attribute 'markdown-header-face
                          nil
                          :font nl/gui-variable-font-name
                          :weight 'bold
                          :height (* 12 (string-to-number nl/gui-current-variable-font-size)))
      (set-face-attribute 'markdown-link-face
                          nil
                          :font nl/gui-variable-font-name
                          :weight 'bold
                          :height (* 10 (string-to-number nl/gui-current-variable-font-size)))
      )

    (defun ap/load-doom-theme (theme)
      "Disable active themes and load a Doom theme."
      (interactive (list (intern (completing-read "Theme: "
                                                  (->> (custom-available-themes)
                                                       (-map #'symbol-name)
                                                       (--select (string-prefix-p "doom-" it)))))))
      (ap/switch-theme theme))

    (defun ap/switch-theme (theme)
      "Disable active themes and load THEME."
      (interactive (list (intern (completing-read "Theme: "
                                                  (->> (custom-available-themes)
                                                       (-map #'symbol-name))))))
      (mapc #'disable-theme custom-enabled-themes)
      (load-theme theme 'no-confirm))
#+end_src

* Packages bundled with Emacs

** =compile=

Do not ask me to save files before compiling, or kill a previous
compilation. Also scroll to the end of the compilation buffer when it
is opened.

Enable ANSI colors for compilation buffers.

#+begin_src emacs-lisp
(use-package compile
  :bind (("M-O"   . show-compilation)
         ;;("C-c c" . compile)
         )
  :preface
  (defun show-compilation ()
    (interactive)
    (let ((compile-buf
           (catch 'found
             (dolist (buf (buffer-list))
               (if (string-match "\\*compilation\\*" (buffer-name buf))
                   (throw 'found buf))))))
      (if compile-buf
          (switch-to-buffer-other-window compile-buf)
        (call-interactively 'compile))))

  (defun nl/compilation-ansi-color-process-output ()
    (ansi-color-process-output nil)
    (set (make-local-variable 'comint-last-output-start)
         (point-marker)))

  (defun nl/compile-hook ()
    (setq-local compilation-scroll-output t)
    (setq-local scroll-conservatively most-positive-fixnum)
    (setq-local scroll-margin 0))

  ;; (defun colorize-compilation-buffer ()
  ;;   (let ((inhibit-read-only t))
  ;;     (ansi-color-apply-on-region (point-min) (point-max))))
  ;; (add-hook 'compilation-filter-hook 'colorize-compilation-buffer)
  :config
  (setq compilation-ask-about-save nil
        compilation-always-kill t
        compilation-max-output-line-length nil)

  :hook ((compilation-filter . nl/compilation-ansi-color-process-output)
         (compilation-mode . nl/compile-hook)))
#+end_src

** =dired=

Make dired show directories first. Dired buffers should auto revert
and not give any use feedback (source: [[http://whattheemacsd.com/sane-defaults.el-01.html][Magnars Sveen]]).

#+begin_src emacs-lisp
(use-package dired
  :ensure nil
  :custom
  (dired-recursive-copies 'always)
  ;; Auto refresh Dired, but be quiet about it
  (global-auto-revert-non-file-buffers t)
  ;; Move files to trash when deleting
  (delete-by-moving-to-trash t)
  (dired-dwim-target t)
  (find-file-visit-truename t)
  :config
  (setq dired-listing-switches "-aBhl --group-directories-first")
  ;; Reuse same dired buffer, to prevent numerous buffers while navigating in dired
  (put 'dired-find-alternate-file 'disabled nil)
  :hook ((dired-mode . dired-hide-details-mode)
         (dired-mode . hl-line-mode)
         (dired-mode . (lambda ()
                         (local-set-key (kbd "<mouse-2>") #'dired-find-alternate-file)
                         ;;(local-set-key (kbd "RET") #'dired-find-alternate-file)
                         (local-set-key (kbd "^")
                                        (lambda () (interactive) (find-alternate-file "..")))))))
#+end_src

** =emacsclient=

#+begin_src emacs-lisp
(use-package edit-server
  :if (display-graphic-p)
  :preface
  (defun nl/after-init-hook ()
    (server-start t)
    (edit-server-start t)
    (nl/set-fonts nil)
    )
  :init
  (add-hook 'after-init-hook 'nl/after-init-hook))
#+end_src

** =recentf=

Recentf is a minor mode that builds a list of recently opened files.
This list is is automatically saved across Emacs sessions.

Prefer saving the history of opened files somewhere other than the default.

#+begin_src emacs-lisp
(use-package recentf
  :init (recentf-mode 1)
  :custom
  (recentf-save-file "~/.emacs.d/etc/recentf")
  (recentf-max-saved-items 100))
#+end_src

** =savehist=

The history of prompts like =M-:= can be saved, but let's change its
save file and history length first. Also save search entries.

#+begin_src emacs-lisp
(setq savehist-additional-variables '(search-ring regexp-search-ring)
      savehist-file "~/.emacs.d/etc/savehist"
      history-length 150)
(savehist-mode 1)
#+end_src

** =saveplace=

Remember position in a file.

#+begin_src emacs-lisp
(use-package saveplace
  :custom
  (save-place-file (locate-user-emacs-file "etc/saveplace" "places"))
  (save-place-forget-unreadable-files nil)
  (save-place-ignore-files-regexp "\\(?:COMMIT_EDITMSG\\|svn-commit\\.tmp\\|config\\.org\\)$")
  ;; activate it for all buffers
  :init
  ;;(setq-default save-place t)
  (save-place-mode t))
#+end_src

** =winner-mode=

Window management. ~C-c left (winner-undo)~ undoes the last window
configuration change. Redo the changes using ~C-c right (winner-redo)~.
Also move from window to window using Meta and the direction keys.

#+begin_src emacs-lisp
(use-package winner
  :demand t
  :config
  (winner-mode))
#+end_src

* Elpa packages
** [[https://github.com/abo-abo/ace-window][ace-window]]

A package that uses the same idea from ace-jump-mode for
buffer navigation, but applies it to windows. The default keys are
1-9, but it's faster to access the keys on the home row, so that's
what I have them set to (with respect to Dvorak, of course).

#+begin_src emacs-lisp
(use-package ace-window
  :config
  (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l)))
#+end_src

** [[https://github.com/abo-abo/avy][avy]]

A quick way to jump around text in buffers.

#+begin_src emacs-lisp
(use-package avy
  :bind
  (("C-c SPC" . avy-goto-char)
   ("C-:" . avy-goto-char-timer)))
#+end_src

** [[https://github.com/company-mode/company-mode][company-mode]]

Complete anything.

#+begin_src emacs-lisp
(use-package company
  :diminish company-mode
  :bind (:map company-active-map
              ("C-n" . company-select-next)
              ("C-p" . company-select-previous)
              ("M-/" . company-complete-common))
  :hook
  ((emacs-lisp-mode . (lambda ()
                        (setq-local company-backends '(company-elisp))))
   (emacs-lisp-mode . company-mode))
  :custom
  (company-dabbrev-downcase nil "Don't downcase returned candidates.")
  (company-show-numbers t "Numbers are helpful.")
  (company-abort-manual-when-too-short t "Be less enthusiastic about completion.")
  :custom-face
  (company-tooltip ((t (:family "FiraCode Nerd Font" :height 100))))
  :config
  (setq company-idle-delay 0              ;; no delay no autocomplete
        company-minimum-prefix-length 1
        company-tooltip-limit 20)
  )
#+end_src

** [[https://github.com/jordonbiondo/column-enforce-mode][column-enforce-mode]]

#+begin_src emacs-lisp
(use-package column-enforce-mode
  :config
  (setq column-enforce-column 120)
  :hook (progmode-hook . column-enforce-mode))
#+end_src

** Completing-Read

=consult-buffer=

 | Keys  | Description            |
 |-------+------------------------|
 | b SPC | Narrow to buffers      |
 | f SPC | Narrow to recent files |
 | m SPC | Narrow to bookmarks    |
 | p SPC | Narrow to project      |

*** [[https://github.com/minad/consult][consult]]

#+begin_src emacs-lisp
(use-package consult
  ;; Replace bindings. Lazily loaded due by `use-package'.
  :bind (;; C-c bindings (mode-specific-map)
         ("C-c h" . consult-history)
         ("C-c m" . consult-mode-command)
         ("C-c b" . consult-bookmark)
         ("C-c k" . consult-kmacro)
         ;; C-x bindings (ctl-x-map)
         ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
         ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
         ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
         ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
         ;; Custom M-# bindings for fast register access
         ("M-#" . consult-register-load)
         ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
         ("C-M-#" . consult-register)
         ;; Other custom bindings
         ("M-y" . consult-yank-pop)                ;; orig. yank-pop
         ("<help> a" . consult-apropos)            ;; orig. apropos-command
         ;; M-g bindings (goto-map)
         ("M-g e" . consult-compile-error)
         ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
         ("M-g g" . consult-goto-line)             ;; orig. goto-line
         ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
         ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
         ("M-g m" . consult-mark)
         ("M-g k" . consult-global-mark)
         ("M-g i" . consult-imenu)
         ("M-g I" . consult-imenu-project)
         ;; M-s bindings (search-map)
         ("M-s f" . consult-find)
         ("M-s F" . consult-locate)
         ("M-s g" . consult-grep)
         ("M-s G" . consult-git-grep)
         ("M-s r" . consult-ripgrep)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ("M-s m" . consult-multi-occur)
         ("M-s k" . consult-keep-lines)
         ("M-s u" . consult-focus-lines)
         ;; Isearch integration
         ("M-s e" . consult-isearch)
         :map isearch-mode-map
         ("M-e" . consult-isearch)                 ;; orig. isearch-edit-string
         ("M-s e" . consult-isearch)               ;; orig. isearch-edit-string
         ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
         ("M-s L" . consult-line-multi))           ;; needed by consult-line to detect isearch

  ;; Enable automatic preview at point in the *Completions* buffer.
  ;; This is relevant when you use the default completion UI,
  ;; and not necessary for Vertico, Selectrum, etc.
  :hook (completion-list-mode . consult-preview-at-point-mode)

  ;; The :init configuration is always executed (Not lazy)
  :init

  ;; Optionally configure the register formatting. This improves the register
  ;; preview for `consult-register', `consult-register-load',
  ;; `consult-register-store' and the Emacs built-ins.
  (setq register-preview-delay 0
        register-preview-function #'consult-register-format)

  ;; Optionally tweak the register preview window.
  ;; This adds thin lines, sorting and hides the mode line of the window.
  (advice-add #'register-preview :override #'consult-register-window)

  ;; Optionally replace `completing-read-multiple' with an enhanced version.
  ;;(advice-add #'completing-read-multiple :override #'consult-completing-read-multiple)

  ;; Use Consult to select xref locations with preview
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)

  ;; Configure other variables and modes in the :config section,
  ;; after lazily loading the package.
  :config

  ;; Optionally configure preview. The default value
  ;; is 'any, such that any key triggers the preview.
  ;; (setq consult-preview-key 'any)
  ;; (setq consult-preview-key (kbd "M-."))
  ;; (setq consult-preview-key (list (kbd "<S-down>") (kbd "<S-up>")))
  ;; For some commands and buffer sources it is useful to configure the
  ;; :preview-key on a per-command basis using the `consult-customize' macro.
  (consult-customize
   consult-theme
   :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file consult-xref
   consult--source-recent-file consult--source-project-recent-file consult--source-bookmark
   :preview-key (kbd "M-."))

  ;; Optionally configure the narrowing key.
  ;; Both < and C-+ work reasonably well.
  (setq consult-narrow-key "<") ;; (kbd "C-+")

  ;; Optionally make narrowing help available in the minibuffer.
  ;; You may want to use `embark-prefix-help-command' or which-key instead.
  ;; (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help)

  ;; configure a function which returns the project root directory.
  (autoload 'projectile-project-root "projectile")
  (setq consult-project-root-function #'projectile-project-root)
)
#+end_src

*** [[https://gitlab.com/OlMon/consult-projectile][consult-projectile]]

#+begin_src emacs-lisp
(use-package consult-projectile
  :after (consult))
#+end_src

*** [[https://github.com/mohkale/consult-yasnippet][consult-yasnippet]]

#+begin_src emacs-lisp
(use-package consult-yasnippet)
#+end_src

*** [[https://github.com/oantolin/embark][embark]]

- ~M-x embark-collect-snapshot~ - Within an embark session, save results to a buffer

#+begin_src emacs-lisp
(use-package marginalia
  ;; Either bind `marginalia-cycle` globally or only in the minibuffer
  :bind (("M-A" . marginalia-cycle)
         :map minibuffer-local-map
         ("M-A" . marginalia-cycle))
  :init
  (marginalia-mode))

(use-package embark
  :ensure t

  :bind
  (("C-." . embark-act)         ;; pick some comfortable binding
   ("C-;" . embark-dwim)        ;; good alternative: M-.
   ("C-h B" . embark-bindings))  ;; alternative for `describe-bindings'

  :preface

  (defmacro my/embark-ace-action (fn)
    `(defun ,(intern (concat "my/embark-ace-" (symbol-name fn))) ()
       (interactive)
       (with-demoted-errors "%s"
         (require 'ace-window)
         (let ((aw-dispatch-always t))
           (aw-switch-to-window (aw-select nil))
           (call-interactively (symbol-function ',fn))))))

  :init

  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)

  :config

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))


  (define-key embark-file-map     (kbd "o") (my/embark-ace-action find-file))
  (define-key embark-buffer-map   (kbd "o") (my/embark-ace-action switch-to-buffer))
  (define-key embark-bookmark-map (kbd "o") (my/embark-ace-action bookmark-jump))
  )

;; Consult users will also want the embark-consult package.
(use-package embark-consult
  :ensure t
  :after (embark consult)
  :demand t ; only necessary if you have the hook below
  ;; if you want to have consult previews as you move around an
  ;; auto-updating embark collect buffer
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

*** [[https://github.com/minad/vertico][vertico]]

#+begin_src emacs-lisp
(use-package vertico
  :init
  (vertico-mode)

  ;; Grow and shrink the Vertico minibuffer
  ;; (setq vertico-resize t)

  ;; Optionally enable cycling for `vertico-next' and `vertico-previous'.
  (setq vertico-cycle t)
  )

;; Use the `orderless' completion style.
;; Enable `partial-completion' for file path expansion.
;; You may prefer to use `initials' instead of `partial-completion'.
(use-package orderless
  :init
  (setq completion-styles '(orderless)
        completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion)))))

;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
  :init
  (savehist-mode))

;; A few more useful configurations...
(use-package emacs
  :init
  ;; Add prompt indicator to `completing-read-multiple'.
  ;; Alternatively try `consult-completing-read-multiple'.
  (defun crm-indicator (args)
    (cons (concat "[CRM] " (car args)) (cdr args)))
  (advice-add #'completing-read-multiple :filter-args #'crm-indicator)

  ;; Do not allow the cursor in the minibuffer prompt
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

  ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
  ;; Vertico commands are hidden in normal buffers.
  ;; (setq read-extended-command-predicate
  ;;       #'command-completion-default-include-p)

  ;; Enable recursive minibuffers
  (setq enable-recursive-minibuffers t))
#+end_src
*
** [[https://github.com/emacs-dashboard/emacs-dashboard][dashboard]]

#+begin_src emacs-lisp
(use-package dashboard
  :demand t
  :custom
  (dashboard-projects-backend 'projectile)
  :config
  (setq dashboard-items '((recents  . 5)
                          (projects . 5)
                          (bookmarks . 5)
                          (agenda . 5)
                          (registers . 5)))
  (dashboard-setup-startup-hook))
#+end_src
** [[https://github.com/spotify/dockerfile-mode][dockerfile-mode]]

#+begin_src emacs-lisp
(use-package dockerfile-mode
  :mode ("Dockerfile\\'" . dockerfile-mode))
#+end_src

** Git
*** [[https://github.com/magit/magit][magit]]

A great interface for git projects. It's much more pleasant to use than the git interface on the
command line. Use an easy keybinding to access magit.

#+begin_src emacs-lisp
(use-package magit
  :bind (("C-x g" . magit-status))
  :hook (magit-mode . magit-todos-mode)
  :config
  (define-key magit-status-mode-map (kbd "q") 'magit-quit-session)
  (setq-default vc-handled-backends '(Git))
  (setq magit-push-always-verify nil

        ;; only use A and B in Ediff
        magit-ediff-dwim-show-on-hunks t)
  (magit-add-section-hook 'magit-status-sections-hook
                          'magit-insert-modules
                          'magit-insert-stashes
                          'append))
#+end_src

**** Fullscreen magit

#+BEGIN_QUOTE
The following code makes magit-status run alone in the frame, and then restores the old window
configuration when you quit out of magit.

No more juggling windows after commiting. It's magit bliss.
#+END_QUOTE
[[http://whattheemacsd.com/setup-magit.el-01.html][Source: Magnar Sveen]]

#+begin_src emacs-lisp
;; full screen magit-status
(defadvice magit-status (around magit-fullscreen activate)
  (window-configuration-to-register :magit-fullscreen)
  ad-do-it
  (delete-other-windows))

(defun magit-quit-session ()
  "Restores the previous window configuration and kills the magit buffer"
  (interactive)
  (kill-buffer)
  (jump-to-register :magit-fullscreen))
#+end_src

**** File log

=M-x magit-log-buffer-file=

*** [[https://github.com/alphapapa/magit-todos][magit-todos]]

#+begin_src emacs-lisp
(use-package magit-todos
  :diminish
  :after magit
  :custom
  (magit-todos-auto-group-items 'always)
  (magit-todos-group-by '(magit-todos-item-keyword magit-todos-item-filename))
  :config
  (magit-todos-mode))
#+end_src

*** [[https://gitlab.com/pidu/git-timemachine][git-timemachine]]

#+begin_src emacs-lisp
(use-package git-timemachine
  :commands git-timemachine)
#+end_src

*** [[https://github.com/syohex/emacs-git-gutter][emacs-git-gutter]]

#+begin_src emacs-lisp
(use-package git-gutter
  :diminish git-gutter-mode
  :hook (prog-mode . git-gutter-mode))
#+end_src

** [[https://github.com/magnars/expand-region.el][expand-region]]

#+begin_src emacs-lisp
(use-package expand-region
  ;; :load-path (lambda () (expand-file-name "~/src/github/elisp/expand-region.el"))
  :bind
  ("C-=" . er/expand-region)
  :config
  (setq expand-region-smart-cursor t
        er/enable-subword-mode? nil))
#+end_src

** [[https://github.com/flycheck/flycheck][flycheck]]

#+begin_src emacs-lisp
(use-package flycheck
  :commands global-flycheck-mode
  :diminish flycheck-mode
  :commands flycheck-define-checker
  :init
  (global-flycheck-mode)
  :config
  (setq flycheck-standard-error-navigation nil)

  (setq-default flycheck-disabled-checkers
                (append flycheck-disabled-checkers
                        '(javascript-jshint)))

  (setq flycheck-checkers (append flycheck-checkers
                                  '(javascript-eslint))
        flycheck-python-flake8-executable "flake8")
  ;; use eslint with web-mode for jsx files
  (flycheck-add-mode 'javascript-eslint 'web-mode)
  (flycheck-add-mode 'javascript-eslint 'js2-mode)
  (flycheck-add-mode 'javascript-eslint 'js-mode))
#+end_src

** [[https://github.com/nflath/hungry-delete][hungry-delete]]

So that hungry deletion can be used in all modes.

#+begin_src emacs-lisp
(use-package hungry-delete
  :diminish hungry-delete-mode
  :init
  (global-hungry-delete-mode))
#+end_src

** [[https://github.com/abo-abo/hydra][hydra]]

This package can be used to tie related commands into a family of
short bindings with a common prefix - a Hydra.

#+begin_src emacs-lisp
(use-package hydra
  :pin melpa
  :init
  (use-package cl-lib)
  (use-package lv)
  (use-package key-chord
    :init
    (setq key-chord-one-key-delay 0.16)
    :config
    (key-chord-mode 1))
  :custom
  (hydra-hint-display-type 'posframe)
  :config
  ;;(setq hydra-posframe-show-params (plist-put hydra-posframe-show-params :font "Fira Code Retina"))
  (setq hydra-posframe-show-params
        (plist-put hydra-posframe-show-params :font nl/gui-fixed-font-name))

  (defun nl/pull-window ()
    "Pull a window to the window the point is at"
    (interactive)
    (aw--push-window (selected-window))
    (ace-swap-window)
    (aw-flip-window))

  (defun nl/open-buffer-in-other-window ()
    "Open buffer in another window."
    (interactive)
    (let ((pt (point))
          (buf (current-buffer))
          (window (ace-select-window)))
      (set-window-buffer window buf)
      (goto-char pt)
      (recenter-top-bottom 'top)))

  ;; http://oremacs.com/2015/01/29/more-hydra-goodness/

  (defun hydra-universal-argument (arg)
    (interactive "P")
    (setq prefix-arg (if (consp arg)
                         (list (* 4 (car arg)))
                       (if (eq arg '-)
                           (list -4)
                         '(4)))))

  (defhydra hydra-files (:columns 2 :color red)
    "Files hydra"
    ("h" (dired "~/.") "home" :column "System")
    ("e" (dired "~/.emacs.d") "Emacs")
    ("c" (dired "~/.config") "Config")
    ("l" (dired "~/.local") "Local")
    ("C" (dired "~/home_config") "My config" :column "Mine")
    ("S" (dired "~/src/nelson/nlscripts") "My scripts")
    ("O" (dired "~/Dropbox/orgfiles") "Org")
    )

  (global-set-key (kbd "C-,") 'hydra-files/body)

  (defhydra hydra-window (:color red :hint nil)
    ("h" windmove-left)
    ("j" windmove-down)
    ("k" windmove-up)
    ("l" windmove-right)
    ("|" (progn (split-window-right) (windmove-right)))
    ("_" (progn (split-window-below) (windmove-down)))
    ("v" split-window-right)
    ("x" split-window-below)
    ("u" winner-undo)
    ("r" winner-redo) ;;Fixme, not working?
    ("a" ace-window :exit t)
    ("f" new-frame :exit t)
    ("o" nl/open-buffer-in-other-window :exit t)
    ("p" nl/pull-window :exit t)
    ("s" ace-swap-window :exit t)
    ("da" ace-delete-window)
    ("dw" delete-window)
    ("db" kill-this-buffer)
    ("df" delete-frame :exit t)
    ("q" nil)
    ;;("i" ace-maximize-window "ace-one" :color blue)
    ("m" headlong-bookmark-jump))

  (key-chord-define-global "yy" 'hydra-window/body)

  (defhydra hydra-buffer (:color blue :columns 3)
    ("n" next-buffer "next" :color red)
    ;;("b" helm-mini "switch")
    ("B" ibuffer "ibuffer")
    ("p" previous-buffer "prev" :color red)
    ("C-b" buffer-menu "buffer menu")
    ("d" kill-this-buffer "delete" :color red)
    ;; don't come back to previous buffer after delete
    ("D" (progn (kill-this-buffer) (next-buffer)) "Delete" :color red)
    ("s" save-buffer "save" :color red))

  (key-chord-define-global "zz" 'hydra-buffer/body)

  (defhydra hydra-goto-line (goto-map "")
    "goto-line"
    ("g" consult-goto-line "go")
    ("m" set-mark-command "mark" :bind nil)
    ("q" nil "quit"))

  (global-set-key (kbd "M-g M-g") 'hydra-goto-line/body)

  (defhydra hydra-windows-nav (:color red)
    ("s" shrink-window-horizontally "shrink horizontally" :column "Sizing")
    ("e" enlarge-window-horizontally "enlarge horizontally")
    ("S" shrink-window "shrink vertically")
    ("E" enlarge-window "enlarge vertically")
    ("b" balance-windows "balance window height")
    ("m" maximize-window "maximize current window")
    ("M" minimize-window "minimize current window")

    ("h" split-window-below "split horizontally" :column "Split management")
    ("v" split-window-right "split vertically")
    ("d" delete-window "delete current window")
    ("x" delete-other-windows "delete-other-windows")


    ("z" ace-window "ace window" :color blue :column "Navigation")
    ("h" windmove-left "← window")
    ("j" windmove-down "↓ window")
    ("k" windmove-up "↑ window")
    ("l" windmove-right "→ window")
    ("r" toggle-window-split "rotate windows") ; Located in utility functions
    ("q" nil "quit menu" :color blue :column nil))

  (global-set-key (kbd "C-c w") 'hydra-windows-nav/body))
#+end_src

** [[https://github.com/emacs-lsp/lsp-mode][lsp-mode]]

#+begin_src emacs-lisp
(use-package which-key
  :config
  (which-key-mode))

(use-package lsp-mode
  ;;:load-path "~/src/github/elisp/lsp-mode"
  :pin melpa
  :commands (lsp lsp-deferred)
  :custom
  (lsp-keymap-prefix "C-c l")
  (lsp-enable-snippet t)
  (lsp-enable-file-watchers nil)
  (lsp-pyls-plugins-pycodestyle-max-line-length 120)
  (lsp-intelephense-php-version "7.4.25")
  (lsp-intelephense-format-enable nil)
  ;;(setq lsp-response-timeout 25)
  :config
  (lsp-enable-which-key-integration t)
  (setq lsp-prefer-capf t
        lsp-idle-delay 0.5
        lsp-pyls-plugins-flake8-enabled t
        lsp-ensabled-clients '(intelephense))
  (setq lsp-clients-angular-language-server-command
        '("node"
          "/home/nelson/.nvm/versions/node/v16.16.0/lib/node_modules/@angular/language-server"
          "--ngProbeLocations"
          "/home/nelson/.nvm/versions/node/v16.16.0/lib/node_modules"
          "--tsProbeLocations"
          "/home/nelson/.nvm/versions/node/v16.16.0/lib/node_modules"
          "--stdio"))
  (lsp-register-custom-settings
   '(("pyls.plugins.pyls_mypy.enabled" t t)
     ("pyls.plugins.pyls_mypy.live_mode" nil t)
     ("pyls.plugins.pyls_black.enabled" t t)
     ("pyls.plugins.pyls_isort.enabled" t t))))

(use-package lsp-ui
  ;; :load-path "~/src/github/elisp/lsp-ui"
  :hook (lsp-mode . lsp-ui-mode)
  :commands lsp-ui-mode
  :bind (:map lsp-ui-mode-map
              ([remap xref-find-definitions] . lsp-ui-peek-find-definitions)
              ([remap xref-find-references] . lsp-ui-peek-find-references)
              ([f10] . lsp-ui-sideline-toggle-symbols-info))
  :custom-face
  (lsp-ui-peek-peek ((nil :background "gray30")))
  (lsp-ui-peek-highlight ((nil :foreground "gray60" :background "gray20")))
  (header-line ((t (:inherit mode-line :background "gray20"))))
  :custom
  (lsp-ui-sideline-enable t)
  (lsp-ui-sideline-show-hover nil)
  (lsp-ui-peek-enable nil)
  (flycheck-add-next-checker 'lsp-ui 'typescript-tslint)
  :config
  (setq lsp-ui-flycheck-list-position 'bottom
        ;;lsp-ui-doc-enable t
        ;;lsp-ui-doc-show-with-cursor t
        ;;lsp-ui-doc-show-with-mouse t
        ;;lsp-ui-doc-use-childframe t
        ;;lsp-ui-doc-position 'top
        ;;lsp-ui-doc-include-signature t
        lsp-ui-peek-always-show nil
        lsp-ui-peek-list-width 60
        lsp-ui-peek-peek-height 25
        lsp-eldoc-enable-hover nil)
  )
#+end_src

** [[https://github.com/defunkt/markdown-mode][markdown-mode]]

#+begin_src emacs-lisp
(use-package markdown-mode
  :commands (markdown-mode gfm-mode)
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.markdown\\'" . markdown-mode)
         ("\\.md\\'"       . markdown-mode))
  :hook
  (markdown-mode . (lambda () (auto-fill-mode -1)))
  (markdown-mode . variable-pitch-mode)
  (markdown-mode . flyspell-mode)
  :config
  (setq markdown-command "pandoc")
  (dolist (face '(markdown-inline-code-face markdown-code-face))
    (set-face-attribute face nil :inherit 'fixed-pitch)))
#+end_src

** [[https://github.com/ancane/markdown-preview-mode][markdown-preview-mode]]

#+begin_src emacs-lisp
(use-package markdown-preview-mode
  :config
  ;;(add-to-list 'markdown-preview-stylesheets
  ;;             "https://raw.githubusercontent.com/richleland/pygments-css/master/emacs.css")
  (setq markdown-preview-stylesheets (list
                                      "http://thomasf.github.io/solarized-css/solarized-dark.min.css")))
#+end_src

** [[https://github.com/emacsfodder/move-text][move-text]]

#+begin_src emacs-lisp
(use-package move-text
  :bind (("C-S-<up>" . move-text-up)
         ("C-S-<down>" . move-text-down)))
#+end_src
** [[https://github.com/magnars/multiple-cursors.el][multiple-cursors]]

Sometimes you end up with cursors outside of your view. You can scroll
the screen to center on each cursor with ~C-v~ and ~M-v~.

#+begin_src emacs-lisp
(use-package multiple-cursors
  :after selected
  :bind (("C-S-c C-S-c" . mc/edit-lines)
         ("C->"         . mc/mark-next-like-this)
         ("C-<"         . mc/mark-previous-like-this)
         ("C-M->"       . mc/unmark-next-like-this)
         ("C-M-<"       . mc/unmark-previous-like-this)
         ("C-c C-<"     . mc/mark-all-like-this)
         ("C-!"         . mc/mark-next-symbol-like-this)
         ("C-x C-m"     . mc/mark-all-dwim))
  :bind (:map selected-keymap
              ("C-'" . mc/edit-lines)
              ("."   . mc/mark-next-like-this)
              ("<"   . mc/unmark-next-like-this)
              ("C->" . mc/skip-to-next-like-this)
              (","   . mc/mark-previous-like-this)
              (">"   . mc/unmark-previous-like-this)
              ("C-<" . mc/skip-to-previous-like-this)
              ("y"   . mc/mark-next-symbol-like-this)
              ("Y"   . mc/mark-previous-symbol-like-this)
              ("w"   . mc/mark-next-word-like-this)
              ("W"   . mc/mark-previous-word-like-this)))
#+end_src

*
** PHP
*** [[https://github.com/ejmr/php-mode][php-mode]]

Flycheck configuration taken from [[https://truongtx.me/2014/07/22/setup-php-development-environment-in-emacs][here]], but had to change the way the ~nl/php-checker~
checker is loaded.

#+begin_src emacs-lisp
(use-package php-mode
  :mode "\\.php[345]?\\'"
  :hook
  (php-mode . display-line-numbers-mode)
  (php-mode . nl/nordita-php-mode-hook)
  :preface
  (defun nl/php-mode-hook ()
    "My PHP mode configuration."
    (lsp)
    (flycheck-mode t)
    (php-set-style "nl/php"));; this style is based on the symfony2 style

  (defun nl/nordita-php-mode-hook ()
    "Nordita's PHP mode configuration."
    (lsp)
    (flycheck-mode t)
    ;; for help with enabling python-flake8 see https://github.com/emacs-lsp/lsp-mode/issues/2594
    (require 'lsp-diagnostics)
    (lsp-diagnostics-flycheck-enable)
    (flycheck-add-next-checker 'lsp 'php-phpcs)
    (cond ((string= (projectile-project-root) (expand-file-name "~/src/nordita/norweb-2021/"))
           (setq lsp-intelephense-files-exclude
                 (vconcat lsp-intelephense-files-exclude
                          ["public/wire/**"
                           "public/wire.old/**"
                           "**/AppApi/**"
                           "**/FieldtypeCombo/**"
                           "**/FieldtypeFieldsetGroup/**"
                           "**/FieldtypeRepeaterMatrix/**"
                           "**/FieldtypeTextareas/**"
                           "**/FileValidatorSvgSanitizer/**"
                           "**/InputfieldCKEditor/**"
                           "**/ProcessHannaCode/**"
                           "**/pw-fieldtype-yaml/**"
                           "**/RockMigrations/**"
                           "**/TracyDebugger/**"
                           ])
                 lsp-intelephense-rename-exclude
                 (vconcat lsp-intelephense-rename-exclude
                          ["public/wire/**"
                           "public/wire.old/**"
                           "**/AppApi/**"
                           "**/FieldtypeCombo/**"
                           "**/FieldtypeFieldsetGroup/**"
                           "**/FieldtypeRepeaterMatrix/**"
                           "**/FieldtypeTextareas/**"
                           "**/FileValidatorSvgSanitizer/**"
                           "**/InputfieldCKEditor/**"
                           "**/ProcessHannaCode/**"
                           "**/pw-fieldtype-yaml/**"
                           "**/RockMigrations/**"
                           "**/TracyDebugger/**"
                           ])
                 lsp-intelephense-php-version "7.4")
           ))
    )

  ;; this style is based on the symfony2 style
  (c-add-style
   "nl/php"
   '("php"
     (c-basic-offset . 2)
     (indent-tabs-mode . nil)
     (c-offsets-alist . ((statement-cont . php-lineup-hanging-semicolon)))
     (c-indent-comments-syntactically-p . t)
     (fill-column . 120)
     (require-final-newline . t)))

  ;; see https://github.com/taksatou/dotfiles/blob/037e22d7a31112321b92e11bcbd871b8e2acbc9c/.emacs.d/my/my-codingstyles.el
  (c-add-style
   "nl/php-nordita"
   '("php"
     (c-set-style "k&r")
     (c-basic-offset . 4)
     (indent-tabs-mode . nil)
     (c-offsets-alist . ((defun-open            . 0)
                         (defun-close           . 0)
                         (defun-block-intro     . +)
                         (topmost-intro         . 0)
                         (topmost-intro-cont    . c-lineup-topmost-intro-cont)
                         (block-open            . 0)
                         (block-close           . 0)
                         (statement             . 0)
                         (statement-cont        . +)
                         (statement-block-intro . +)
                         (statement-case-intro  . +)
                         (statement-case-open   . 0)
                         (substatement          . +)
                         (substatement-open     . 0)
                         (case-label            . +)
                         (comment-intro         . (c-lineup-knr-region-comment c-lineup-comment))
                         (arglist-intro         . +)
                         (arglist-cont          . (c-lineup-gcc-asm-reg 0))
                         (arglist-cont-nonempty . +)
                         (arglist-close         . 0)
                         ))
     (c-indent-comments-syntactically-p . t)
     (php-mode-lineup-cascaded-calls . nil)
     (show-trailing-whitespace . nil)
     (fill-column . 120)
     (require-final-newline . t)))

  (flycheck-define-checker nl/php-checker
    "A PHP syntax checker using the PHP command line interpreter.
     See URL http://php.net/manual/en/features.commandline.php."
    :command ("php" "-l" "-d" "error_reporting=E_ALL" "-d" "display_errors=1"
              "-d" "log_errors=0" source)
    :error-patterns
    ((error line-start (or "Parse" "Fatal" "syntax") " error" (any ":" ",") " "
            (message) " in " (file-name) " on line " line line-end))
    :modes (php-mode web-mode))

  (eval-after-load 'flycheck
    '(add-to-list 'flycheck-checkers 'nl/php-checker))
  :custom
  (php-mode-coding-style (quote nl/php-nordita))
  (php-mode-lineup-cascaded-calls t))
#+end_src

*** [[https://github.com/nlamirault/phpunit.el][php-unit]]

#+begin_src emacs-lisp
(use-package phpunit
  :after (php-mode)
  :bind (:map php-mode-map
              ("C-c , t" . phpunit-current-test)
              ("C-c , c" . phpunit-current-class)
              ("C-c , p" . phpunit-current-project))
  :init
  (push `(php-error-regexp
          ,(rx line-start
               (zero-or-more "Trace:" space)
               "#" (one-or-more digit)
               (zero-or-more space)
               (group-n 1 (one-or-more (not (in space "(" "\n"))))
               "(" (group-n 2 (one-or-more digit))
               (zero-or-more not-newline))
          1 2)
        compilation-error-regexp-alist-alist)
  (push 'php-error-regexp compilation-error-regexp-alist)
  :custom
  (phpunit-arg "--stderr --debug"))
#+end_src

*** [[https://github.com/OVYA/php-cs-fixer][php-cs-fixer]]

Allows the Emacs editor to fix most issues in PHP code when you want to follow the coding standards
PSR-1 and PSR-2.

#+begin_src emacs-lisp
(use-package php-cs-fixer
  :load-path "~/src/github/elisp/php-cs-fixer"
  :hook ((before-save . php-cs-fixer-before-save)))
#+end_src

** [[https://github.com/bbatsov/projectile][projectile]]

#+BEGIN_QUOTE
Project navigation and management library for Emacs.
#+END_QUOTE


#+begin_src emacs-lisp
(use-package projectile
  :diminish projectile-mode
  :bind-keymap
  ("C-c p" . projectile-command-map)
  :bind (:map projectile-command-map ("f" . consult-projectile))
  :init (projectile-mode +1)
  :config
  ;; tramp-fix: https://github.com/syl20bnr/spacemacs/issues/11381
  ;; (defadvice projectile-project-root (around ignore-remote first activate)
  ;;   (unless (file-remote-p default-directory) ad-do-it))

  (setq projectile-indexing-method 'alien
        projectile-remember-window-configs nil
        projectile-switch-project-action 'projectile-dired
        projectile-completion-system 'default
        projectile-enable-caching nil
        projectile-create-missing-test-files t
        projectile-mode-line "Projectile")

  (def-projectile-commander-method ?d
    "Open project root in dired."
    (projectile-dired)))
#+end_src

** [[https://github.com/tumashu/posframe][posframe]]

#+begin_src emacs-lisp
(use-package posframe
  :pin melpa
  :init
  (setq x-gtk-resize-child-frames 'resize-mode))
#+end_src

** prettier

#+begin_src emacs-lisp
    (use-package prettier
      :diminish perttier-mode
      :hook ((typescript-tsx-mode . prettier-mode)
             (typescript-mode . prettier-mode)
             (js-mode . prettier-mode)
             (json-mode . prettier-mode)
             (css-mode . prettier-mode)
             (scss-mode . prettier-mode)))
#+end_src

** [[https://github.com/Kungsgeten/selected.el][selected]]

#+begin_src emacs-lisp
(use-package selected
  :diminish selected-minor-mode
  ;; :bind (:map selected-keymap
  ;;            ("M-%" . query-replace-regexp)
  ;;            ("C-[" . align-entire)
  ;;            ("C-f" . fill-region)
  ;;            ("C-U" . unfill-region)
  ;;            ("C-d" . downcase-region)
  ;;            ("C-r" . reverse-region)
  ;;            ("C-s" . sort-lines)
  ;;            ("C-u" . upcase-region))
  :init (selected-global-mode 1))
#+end_src

** Python

*** lsp-pyright

#+begin_src emacs-lisp
(use-package lsp-pyright
  :preface
  (defun nl/pyright-hook ()
    (require 'lsp-pyright))
  :hook
  (python-mode . nl/pyright-hook)
  (python-mode . lsp-deferred))
#+end_src

** typescript

#+begin_src emacs-lisp
(use-package typescript-mode
  :diminish typescript-mode
  :mode ("\\.ts\\'" "\\.tsx\\'" "\\.js\\'")
  :hook
  (typescript-mode . display-line-numbers-mode)
  (typescript-mode . lsp-deferred)
  (typescript-mode . column-enforce-mode)
  ;;(typescript-mode . rainbow-delimiters-mode)
  (typescript-mode . nl/typescript-mode)
  :preface
  (defun nl/typescript-mode ()
    (flycheck-mode +1)
    ;;(eldoc-mode +1)
    (company-mode +1)
    (subword-mode +1)

    ;; need to override the value set in typescript-mode.el
    (push '(typescript-tsc-pretty
            "^\\(?:\\(Error\\|Warning\\)\\):[[:blank:]]\\([^:]+\\):\\([[:digit:]]+\\):\\([[:digit:]]+\\)"
            2 3 4 1)
          compilation-error-regexp-alist-alist)

    ;;(setq prettify-symbols-alist nl-typescript-prettify-symbols)
    (prettify-symbols-mode))
  :config
  (setq company-tooltip-align-annotations t ;; aligns annotation to the right hand side
        ;;prettify-symbols-unprettify-at-point 'right-edge
        flycheck-check-syntax-automatically '(save mode-enabled))
  (setq-default typescript-indent-level 4)
  )
#+end_src

** [[https://github.com/fxbois/web-mode][web-mode]]

For TSX see: https://github.com/emacs-typescript/typescript.el/issues/4#issuecomment-947866123

#+begin_src emacs-lisp
(use-package web-mode
  :hook ((web-mode . lsp)
         (typescript-tsx-mode . lsp))
  :mode (("\\.html\\'" . web-mode)
         ("\\.html\\.eex\\'" . web-mode)
         ("\\.html\\.tera\\'" . web-mode)
         ("\\.tsx\\'" . typescript-tsx-mode))
  :init
  (define-derived-mode typescript-tsx-mode typescript-mode "TypeScript-tsx")
  :config
  (setq web-mode-markup-indent-offset 2
        web-mode-css-indent-offset 2
        web-mode-code-indent-offset 2))
#+end_src

** [[https://github.com/yoshiki/yaml-mode][yaml-mode]]

#+begin_src emacs-lisp
(use-package yaml-mode
  :config
  (add-to-list 'auto-mode-alist '("\\.yml\\'" . yaml-mode)))
#+end_src

** [[https://github.com/capitaomorte/yasnippet][yasnippet]]

It takes a few seconds to load and I don't need them immediately when
Emacs starts up, so we can defer loading yasnippet until there's some
idle time.

Large collection of snippets: [[https://github.com/AndreaCrotti/yasnippet-snippets][Andrea Crotti's collection]].

#+begin_src emacs-lisp
(use-package yasnippet
  :diminish yas-minor-mode
  :hook (prog-mode . yas-minor-mode)
  ;;:init
  ;;(yas-global-mode 1)
  :config
  (use-package yasnippet-snippets)
  (yas-reload-all))
#+end_src

*** [[https://github.com/AndreaCrotti/yasnippet-snippets][yasnippet-snippets]]


** Org mode

#+begin_src emacs-lisp
(use-package org
  :pin org
  :bind
  ("C-c c" . org-capture)
  ;;:hook (org-mode . nl/org-mode-setup)
  :custom-face
  (org-table ((t :foreground "#91b831")))
  :preface
  (defun nl/org-confirm-babel-evaluate (lang body)
    "Do not confirm evaluation for these languages."
    (not (or (string= lang "C")
             (string= lang "emacs-lisp")
             (string= lang "java")
             (string= lang "python")
             (string= lang "sh")
             (string= lang "sql")
             (string= lang "sqlite"))))
  :config
  (setq org-ellipsis " ⤵"
        org-hide-emphasis-markers t
        org-catch-invisible-edits 'error
        org-startup-indented t
        org-cycle-include-plain-lists 'integrate
        org-return-follows-link t
        org-M-RET-may-split-line nil
        org-src-fontify-natively t
        org-src-preserve-indentation t
        org-edit-src-content-indentation 0
        org-enforce-todo-dependencies t
        org-enforce-todo-checkbox-dependencies t
        ;; org-link-frame-setup '((file . find-file))
        org-export-backends '(ascii html icalendar latex md)
        org-log-into-drawer t)

  (setq org-capture-templates
        '(("t" "Todo" entry (file+headline "~/Sync/orgfiles/todo.org" "Tasks")
           "* TODO %?\n  %i\n  %a")
          ("l" "Link" entry (file+headline "~/Sync/orgfiles/links.org" "Links")
           "* %? %^L %^g \n%T" :prepend t)
          ("n" "Note" entry (file "~/Sync/orgfiles/notes.org")
           "* NOTE %?\n%U" :empty-lines 1)
          ("N" "Note with Clipboard" entry (file "~/Sync/orgfiles/notes.org")
           "* NOTE %?\n%U\n   %c" :empty-lines 1)
          ("j" "Journal" entry (file+datetree "~/Sync/orgfiles/journal.org")
           "* %?\nEntered on %U\n  %i\n  %a")))
  )

(with-eval-after-load 'org
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((C . t)
     (calc . t)
     (emacs-lisp . t)
     (latex . t)
     (java . t)
     (js . t)
     (python . t)
     (ruby . t)
     (shell . t)
     (sql . t)
     (sqlite . t)))
  (setq org-confirm-babel-evaluate 'nl/org-confirm-babel-evaluate))
#+end_src

*** Structure templates

#+begin_src emacs-lisp
(with-eval-after-load 'org
  ;; This is needed as of Org 9.2
  (require 'org-tempo)

  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python")))
#+end_src
