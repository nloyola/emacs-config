#+TITLE: Emacs Configuration
#+AUTHOR: Nelson Loyola
#+STARTUP: content
#+INFOJS_OPT: view:t toc:t ltoc:t mouse:underline buttons:0 path:http://thomasf.github.io/solarized-css/org-info.min.j
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://thomasf.github.io/solarized-css/solarized-light.min.css" />
#+OPTIONS: broken-links:t
#+PROPERTY: header-args  :results silent
#+EXPORT_FIle_NAME: ~/output/emacs-config.html
#+OPTIONS: toc:nil html-postamble:nil

Links:
- ~use-pacakge~: https://github.com/jwiegley/use-package

* Basic settings

Override various default settings and key bindings.

See https://tony-zorman.com/posts/emacs-potpourri.html

#+begin_src emacs-lisp
(use-package emacs
  :preface
  (when (eq system-type 'darwin)
    (require 'ls-lisp)
    (setq ls-lisp-use-insert-directory-program nil))

  (setq user-full-name "Nelson Loyola"
        user-mail-address "nloyola@gmail.com"
        custom-file (expand-file-name "custom.el" user-emacs-directory))

  (load custom-file)

  (setq comp-async-report-warnings-errors nil ;; native-comp warnings
        byte-compile-warnings '(not free-vars unresolved noruntime lexical make-local))

  (put 'downcase-region 'disabled nil)
  (put 'upcase-region 'disabled nil)
  (put 'narrow-to-region 'disabled nil)
  (put 'dired-find-alternate-file 'disabled nil)
  (put 'erase-buffer 'disabled nil)

  ;; Sentences end with a single space.
  (setq sentence-end-double-space nil)

  ;; Set the default major mode to =text-mode=. By default it's =fundamental= mode which is
  ;; not what we want. Also, use =text-mode= for the scratch buffer.
  (setq default-major-mode 'text-mode
        initial-major-mode 'text-mode)

  ;; Don't scroll to middle of the page. Also, scroll line by line, without
  ;; scrolloff and try to keep point at the same visual place when
  ;; scrolling by page.
  (setq-default scroll-up-aggressively 0.01 scroll-down-aggressively 0.01)
  (setq redisplay-dont-pause t
        scroll-step 1
        scroll-margin 3
        scroll-conservatively 10
        scroll-preserve-screen-position t)

  ;; Level of decoration {1 - 3}, t = max.
  (setq font-lock-maximum-decoration t)

  ;; For symlinks, automatically follow the link and visit the real file instead.
  (setq vc-follow-symlinks nil)

  ;; Make searches case insensitive.
  (setq-default case-fold-search t)

  ;; Autosave files are created between saves after a sufficient timeout in
  ;; the current directory for crash detection, they begin and end with
  ;; =#=.  Change this location to the emacs directory.
  (setq auto-save-list-file-prefix "~/.emacs.d/autosave/"
        auto-save-file-name-transforms `((".*" "~/.emacs.d/autosave/" t))
        backup-directory-alist `(("." . ,(concat user-emacs-directory "autosave"))))

  ;;Set line wrap at column 100.
  (setq-default fill-column 100)

  ;; Replace =yes or no= prompt with =y or n= prompt.
  (defalias 'yes-or-no-p 'y-or-n-p)

  ;; Use UTF-8 everywhere.
  (setq locale-coding-system 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (set-selection-coding-system 'utf-8)
  (prefer-coding-system 'utf-8)

  ;; Use spaces instead of tabs.
  (setq-default indent-tabs-mode nil)

  ;; Delete the region when typing, just like as we expect nowadays.
  (delete-selection-mode t)

  ;; Highlight matches in query-replace mode.
  (setq query-replace-highlight t)

  ;; Use visual line mode to display long lines.
  (global-visual-line-mode -1)

  ;;Revert these files without asking.
  (setq revert-without-query '(".*"))

  ;; Middle-clicking is nice to paste, however it should not adjust point
  ;; and paste at the then adjusted point.
  (setq mouse-yank-at-point t)

  ;; Save clipboard data of other programs in the kill ring when possible.
  (setq save-interprogram-paste-before-kill t)

  ;; Set environment variable for shells.
  (setenv "PAGER" "cat")

  ;; Configure =next-buffer= and =previous-buffer= to only visit file
  ;; buffers (has to be called for each frame):
  (set-frame-parameter (selected-frame) 'buffer-predicate #'buffer-file-name)

  ;; These are taken from
  ;; https://github.com/patrickt/emacs/blob/master/init.el:
  (setq
   kill-whole-line t                      ; Lets C-k delete the whole line
   ;;default-directory "~/src/"             ; My code lives here
   enable-recursive-minibuffers t         ; don't freak out if I use the minibuffer twice
   sentence-end-double-space nil          ; are you kidding me
   confirm-kill-processes nil             ; don't when quitting
   )

  (setq-default cursor-type 'box
                cursor-in-non-selected-windows nil)

  ;; Cursor Movement
  (setq auto-window-vscroll nil)

  ;; Turn off auto-save.
  (setq auto-save-default nil)

  ;; Don't make any backup files.
  (setq make-backup-files nil)

  ;; Get rid of the menu bar. Tool bar and scroll bars are disabled in
  ;; ~init.el~..
  (when (fboundp 'menu-bar-mode) (menu-bar-mode -1))

  ;; Turn off the blinking cursor.
  (blink-cursor-mode -1)

  ;; Don't use dialog boxes
  (setq use-dialog-box nil)

  ;; Don't want an audible bell.
  (setq visible-bell t)

  ;; Display the running program and the selected buffer in the frame title.
  (setq frame-title-format
        '("" invocation-name ": " (:eval (replace-regexp-in-string
                                          "^ +" "" (buffer-name)))))
  ;; Don't add new lines past end of file, and indicate unused lines at the
  ;; end of the window with a small image in the left fringe.
  (setq next-line-add-newlines nil)
  (setq-default indicate-empty-lines t)

  ;; Add =\n= to end of file if required.
  (setq require-final-newline t)

  ;; Eshell
  (setq eshell-history-size 100000)

  ;; Follow Buffer

  (add-to-list 'auto-mode-alist '("\\.log\\'" . auto-revert-mode))

  ;; Don’t compact font caches during GC.
  (setq inhibit-compacting-font-caches t)

  ;; Automatically cycle through the highlighting faces listed in
  ;; ~hi-lock-face-defaults~ instead of bothering the user to pick a face
  ;; each time.
  (setq hi-lock-auto-select-face t)

  ;; History
  (setq history-delete-duplicates t)

  ;; Use the directory name to make buffer names unique.
  (setq uniquify-buffer-name-style 'forward)

  (global-so-long-mode 1)

  (setq fit-window-to-buffer-horizontally t)
  (setq window-resize-pixelwise t)

  (setq-default indent-tabs-mode nil)

  (setq bookmark-default-file "~/.emacs.d/etc/bookmarks")

  (windmove-default-keybindings 'meta)

  (electric-pair-mode 1)
  (setq electric-pair-pairs
        '(
          (?\" . ?\")
          (?\' . ?\')
          (?\{ . ?\})))
  (show-paren-mode 1)
  :bind
  ("C-z" . nil)     ;; I never want to suspend the frame
  ("M-%" . query-replace-regexp)
  ("C-S-s" . isearch-forward)
  ("C-x C-n" . next-error)
  ("C-x k" . nl/kill-this-buffer)
  ("M-f" . forward-to-word)
  ("M-B" . backward-to-word)
  ("<f1>" . indent-for-tab-command)
  ("S-<f1>" . indent-region)
  ("C-<f1>" . find-file-at-point)
  ("<f2>" . (lambda () (interactive) (save-some-buffers t)))
  ("S-<f2>" . (lambda () (interactive) (revert-buffer t t)))
  ("S-<f5>" . toggle-truncate-lines)
  ("<f8>" . window-toggle-side-windows)
  ("S-<f11>" . eval-region)
  ("C-S-<f11>" . align-regexp)
  )
#+end_src

** =zap-up-to-char=

#+begin_src emacs-lisp
(use-package emacs
  :preface
  (autoload 'zap-up-to-char "misc"
  "kill up to, but not including ARG'th occurence of CHAR.
   \(fn arg char)"
  'interactive)
  :bind
  ("M-z" . zap-up-to-char))
#+end_src

** mouse avoidance
Don't let mouse icon obscure cursor

#+begin_src emacs-lisp :tangle no
(mouse-avoidance-mode 'animate)
#+end_src

* Fonts
** Main fonts

Help from here:  https://howardabrams.com/hamacs/ha-display.html#org54a2529

#+begin_src emacs-lisp
(require 's)
(defvar nl/gui-fixed-font-name
  (when window-system
    (or
     (seq-first
      (seq-filter (lambda (font) (when (x-list-fonts font) font))
                  '("JetBrainsMono Nerd Font"
                    "CaskaydiaCove Nerd Font"
                    ;; funky font with litagures and a dotted 0
                    "Cascadia Code PL"
                    ;; clean font, but no litagures!?
                    "Hack Nerd Font"
                    "FiraCode Nerd Font"       ; has litagures
                    "Cousine Nerd Font"
                    "Iosevka Nerd Font"
                    "FantasqueSansMono Nerd Font"
                    "Monoid Nerd Font"
                    "Hasklig"
                    "Source Code Pro"
                    ;;
                    "IBM Plex Mono Medium"
                    "DejaVu Sans")))
     "monospaced"))
  "My fixed width font based on what I have installed.")

(defvar nl/gui-variable-font-name
  (when window-system
    (or
     (seq-first
      (seq-filter (lambda (font) (when (x-list-fonts font) font))
                  '("SN Pro"   ; https://supernotes.app/open-source/sn-pro
                    "Atkinson Hyperlegible"
                    "Literata" ; Clean, readable with litagures
                    ;; Next best can be downloaded here:
                    ;; https://fontesk.com/xcharter-typeface/
                    "XCharter"
                    "Charter"
                    ;;  Interesting idea: "Iosevka Comfy Motion Duo"
                    "Serif"
                    ;;
                    "Alegreya")))
     (warn "Cannot find a Serif Font.  Install Source Sans Pro."))))

(defvar ha-variable-header-font
  (when window-system
    (or
     (seq-first
      (seq-filter (lambda (font) (when (x-list-fonts font) font))
                  '("SN Pro" "Overpass" "DejaVu Sans"
                    "Verdana" "Overpass"
                    "Source Sans Pro"
                    "Lucida Grande"
                    "Sans Serif")))
     (warn "Cannot find a Sans Serif Font.  Install Source Sans Pro."))))

(defun nl/set-favorite-font-size (size)
  "Set the default font size as well as equalize the fixed and variable fonts."
  (let ((fav-font (format "%s-%d" nl/gui-fixed-font-name size)))
    (set-face-attribute 'default nil :font fav-font)
    (set-face-attribute 'fixed-pitch nil :family nl/gui-fixed-font-name :inherit 'default :height 1.0)
    (set-face-attribute 'variable-pitch nil :family nl/gui-variable-font-name :inherit 'default :height 1.3)))

(defun nl/mac-monitor-fontsize ()
  "Quickly set reset my font size when I connect my laptop to a monitor on a Mac."
  (interactive)
  (nl/set-favorite-font-size 13))

(defun nl/linux-monitor-fontsize ()
  "Quickly set reset my font size when I connect my laptop to a monitor on Linux."
  (interactive)
  (nl/set-favorite-font-size 12))

(defun nl/mac-laptop-fontsize ()
  "Quickly set reset my font size when I disconnect my laptop to a monitor from a Mac."
  (interactive)
  (nl/set-favorite-font-size 32))

(defun nl/linux-laptop-fontsize ()
  "Quickly set reset my font size when I disconnect my laptop to a monitor from Linux."
  (interactive)
  (nl/set-favorite-font-size 14))

(defun nl/imac-fontsize ()
  "Quickly set reset my font size when I am on my iMac."
  (interactive)
  (ha-set-favorite-font-size 16))

(defun nl/font-monitor-size-default ()
  "Set the default size according to my preference."
  (interactive)
  (cond
   ((s-starts-with? "gudrun" system-name) (nl/linux-laptop-fontsize))
   ((eq system-type 'gnu/linux)         (nl/linux-monitor-fontsize))
   (t                                   (nl/mac-monitor-fontsize))))

(nl/font-monitor-size-default)

;; (defconst nl/gui-font-size-normal 12)

;; (use-package emacs
;;   :preface
;;   (set-face-attribute 'default nil :family nl/gui-fixed-font-name :height (* 10 nl/gui-font-size-normal))
;;   (set-face-attribute 'fixed-pitch nil :family nl/gui-fixed-font-name :inherit 'default)
;;   (set-face-attribute 'variable-pitch nil :family nl/gui-variable-font-name :height 1.5)
;;   (set-face-attribute 'font-lock-comment-face nil :family nl/gui-fixed-font-name :weight 'bold :slant 'italic :inherit 'default)
;;   (set-face-attribute 'italic nil :family nl/gui-fixed-font-name :weight 'normal :slant 'italic)
;;   (set-face-attribute 'bold nil :family nl/gui-fixed-font-name :weight 'bold :weight 'normal)
;;   (set-face-attribute 'bold-italic nil :family nl/gui-fixed-font-name :weight 'bold :slant 'italic)
;;   :config
;;   (when (string-match "-[Mm]icrosoft" operating-system-release)
;;     ;; WSL: WSL1 has "-Microsoft", WSL2 has "-microsoft-standard"
;;     (setq nl/gui-font-size-normal 12))
;;   )
#+end_src

** [[https://gitlab.com/jabranham/mixed-pitch][Mixed Pitch]]

Mixed pitch is a minor mode that enables mixing fixed-pitch (also known as fixed-width or monospace)
and variable-pitch (AKA “proportional”) fonts. It tries to be smart about which fonts get which
face.

#+begin_src emacs-lisp :tangle no
(use-package mixed-pitch
  :config
  (add-to-list 'mixed-pitch-fixed-pitch-faces 'org-property-value)
  (add-to-list 'mixed-pitch-fixed-pitch-faces 'font-lock-comment-face)
  :hook (text-mode . mixed-pitch-mode))
#+end_src

** Mode Line

Customize the mode line. This code has to run after init since setting a theme customize the mode line also.

See https://www.gonsie.com/blorg/modeline.html for additional details.

#+begin_src emacs-lisp
(use-package emacs
  :preface
  (defun nl/mode-line-theme ()
    (set-face-attribute 'mode-line nil
                        :background "#565063"
                        :foreground "white"
                        :box '(:line-width 2 :color "#3d3947")
                        :height 0.8
                        :overline nil
                        :underline nil
                        :inherit 'variable-pitch)

    (set-face-attribute 'mode-line-inactive nil
                        :background "#353644"
                        :foreground "white"
                        :box '(:line-width 2 :color "#353644")
                        :height 0.8
                        :overline nil
                        :inherit 'variable-pitch)

    (set-face-attribute 'mode-line-buffer-id nil :foreground "goldenrod" :height 0.8 :inherit 'variable-pitch)
    (set-face-attribute 'mode-line-emphasis nil :inherit 'fixed-pitch)
    (set-face-attribute 'mode-line-highlight nil :slant 'italic :inherit 'fixed-pitch)
    )
  :init
  (setq-default
   mode-line-format
   (list
    ;; the buffer name; the file name as a tool tip
    '(:eval (propertize " %b "
                        'face
                        (let ((face (buffer-modified-p)))
                          (if face 'mode-line-highlight
                            'mode-line-buffer-id))
                        'help-echo (buffer-file-name)))

    ;; line and column
    " ["
    (propertize "%l" 'face '(:foreground "light sky blue")) ","
    (propertize "%c" 'face '(:foreground "light green"))
    "] "

    ;; relative position, size of file
    " ("
    (propertize "%p" 'face '(:foreground "salmon")) ;; % above top
    "/"
    (propertize "%I" 'face '(:foreground "sandy brown")) ;; size
    ") "

    ;; ansi-term's line or char mode
    ":"
    'mode-line-process
    ":"

    ;; spaces to align right
    '(:eval (propertize
             " " 'display
             `((space :align-to (- (+ right right-fringe right-margin)
                                   ,(+ 50 (string-width (if (listp mode-name) (car mode-name) mode-name))))))))

    ;; the current major mode
    (propertize " %m " 'face '(:foreground "light sky blue"))
    minor-mode-alist
    ))
  :hook (after-init .  nl/mode-line-theme))
#+end_src

* Before save hook
Remove trailing whitespace.

#+begin_src emacs-lisp
(use-package emacs
  :hook
  (before-save . delete-trailing-whitespace)
  )
#+end_src

* Transparency

See: https://kristofferbalintona.me/posts/202206071000/

#+begin_src emacs-lisp
(defun kb/toggle-window-transparency ()
  "Toggle transparency."
  (interactive)
  (let ((alpha-transparency 55))
    (pcase (frame-parameter nil 'alpha-background)
      (alpha-transparency (set-frame-parameter nil 'alpha-background 100))
      (t (set-frame-parameter nil 'alpha-background alpha-transparency)))))
#+end_src

* My functions

#+begin_src emacs-lisp
(use-package emacs
  :preface
  (defun nl/kill-this-buffer ()
    "Kill the current buffer."
    (interactive)
    (kill-buffer (current-buffer)))

  (defun nl/consult-compile ()
    "Use Consult to choose a compile command."
    (interactive)
    (let ((selected-command
           (completing-read "Select a compile command: " compile-history)))
      ;; move this command to the front of the history
      (setq compile-history (remove selected-command compile-history))
      (add-to-list 'compile-history selected-command)
      (compile selected-command)))

  (defun nl/consult-async-shell-command ()
    (interactive)
    (let ((selected-command
           (completing-read "Select a shell command: " shell-command-history)))
      (async-shell-command selected-command)))

  ;; (defun nl/counsel-git-files ()
  ;;   (interactive)
  ;;   (let ((counsel-fzf-cmd "git ls-files | fzf -f \"%s\""))
  ;;     (counsel-fzf)))

  (defun nl/beginning-of-line-or-indentation ()
    "move to beginning of line, or indentation"
    (interactive)
    (if (bolp)
        (back-to-indentation)
      (beginning-of-line)))

  ;; https://www.emacs.dyerdwelling.family/emacs/20240804075952-emacs--finding-files-using-completing-read/
  (defun nl/find-file ()
    "Find file from current directory in many different ways."
    (interactive)
    (let* ((find-options '(("find -type f -printf \"$PWD/%p\\0\"" . :string)
                           ("fdfind --absolute-path --type f -0" . :string)
                           ("rg --follow --files --null" . :string)
                           ("find-name-dired" . :command)))
           (selection (completing-read "Select : " find-options))
           (metadata '((category . file)))
           (file-list)
           (file))
      (pcase (alist-get selection find-options nil nil #'string=)
        (:command
         (call-interactively (intern selection)))
        (:string
         (setq file-list (split-string (shell-command-to-string selection) "\0" t))
         (setq file (completing-read (format "Find file in %s: " (abbreviate-file-name default-directory))
                                     (lambda (str pred action)
                                       (if (eq action 'metadata)
                                           `(metadata . ,metadata)
                                         (complete-with-action action file-list str pred)))
                                     nil t nil 'file-name-history)))
        (when file (find-file (expand-file-name file))))))

  :bind
  ("<home>" . nl/beginning-of-line-or-indentation)
  ("<f5>" . nl/consult-compile)
  ("<C-f5>" . compile)
  )
#+end_src

** Windows

#+begin_src emacs-lisp
(use-package emacs
  :preface
  (setq split-height-threshold 160
        split-width-threshold nil)

  (defun nl/frame-grow-horizontally ()
    "Set the size and position of the Emacs window."
    (interactive)
    (windmove-right)
    (delete-window))

  ;; (let ((win (selected-window)))
  ;;   (set-frame-size frame (* 2 (frame-width)) (frame-height)))
  ;; (split-window-right))

  (defun nl/frame-shrink-horizontally ()
    "Set the size and position of the Emacs window."
    (interactive)
    (when (> (length (window-list)) 1)
      (delete-other-windows))
    (split-window-right)
    ;; show the compilation buffer if there is one
    (let ((win (selected-window))
          (compile-buf (get-compilation-buffer)))
      (when compile-buf
        (switch-to-buffer-other-window compile-buf)
        (select-window win))))

  (defun nl/frame-resize ()
    "Resizes the frame based on its current width."
    (interactive)
    (if (<= (window-total-width) 150)
        (nl/frame-grow-horizontally)
      (nl/frame-shrink-horizontally)))

  (defun nl/split-window-same-file ()
    "Splits the frame into two windows, with the buffer on the rightmost window in left and right windows."
    (interactive)
    (windmove-right)
    (delete-window)
    (split-window-right)
    (windmove-right))
  :bind
  ("<f9>" . nl/frame-resize)
  ("<S-f9>" . nl/split-window-same-file))
#+end_src

** Side windows

#+begin_src emacs-lisp
(defvar nl/side-window-parameters
  '(window-parameters . ((no-other-window . nil)
                         (no-delete-other-windows . t))))

;; (setq display-buffer-alist '())

(add-to-list 'display-buffer-alist
             '("\\(?:\\*\\(?:[Hh]elp\\|shell\\)\\*\\)"
               display-buffer-in-side-window
               (window-width . 0.3)
               (side . right)
               (slot . 1) ;; right side
               (preserve-size . (t . nil))
               ,nl/side-window-parameters))

(add-to-list 'display-buffer-alist
             '("\\(?:\\*\\(?:grep\\|Warnings\\|xref\\|eat\\)\\*\\)"
               display-buffer-in-side-window
               (window-height . 0.18)
               (side . bottom)
               (slot . -1) ;; left side
               (preserve-size . (nil . nil))
               ,nl/side-window-parameters))

(add-to-list 'display-buffer-alist
             '("\\*\\(?:compilation\\|Backtrace\\|Warnings\\|Completions\\|Compile-Log\\|cargo-run\\|\\Flycheck.*\\)\\*"
               display-buffer-in-side-window
               (window-height . 0.2)
               (side . bottom)
               (slot . 1) ;; right side
               (preserve-size . (nil . nil))
               ,nl/side-window-parameters))

#+end_src

* Theme
See https://tinted-theming.github.io/base16-gallery/
** Doom Themes

See https://github.com/doomemacs/themes/tree/screenshots#screenshots

#+begin_src emacs-lisp
(use-package doom-themes
  :init
  (setq doom-themes-enable-bold t    ; if nil, bold is universally disabled
        doom-themes-enable-italic t) ; if nil, italics is universally disabled

  ;;(load-theme 'doom-oceanic-next t)
  (load-theme 'base16-brewer t)

  ;; Enable flashing mode-line on errors
  (doom-themes-visual-bell-config)

  ;;treemacs
  (setq doom-themes-treemacs-theme "doom-colors")
  ;;(doom-themes-treemacs-config)

  ;; Corrects (and improves) org-mode's native fontification.
  (doom-themes-org-config)
  :custom-face
  (corfu-current ((t (:background "dark olive green"))))
  )
#+end_src

Allow changing themes on the fly with the following.

#+begin_src emacs-lisp
(use-package emacs
  :init
  (defun ap/load-doom-theme (theme)
    "Disable active themes and load a Doom theme."
    (interactive (list (intern (completing-read "Theme: "
                                                (->> (custom-available-themes)
                                                     (-map #'symbol-name)
                                                     (--select (string-prefix-p "doom-" it))))))))
  (defun ap/switch-theme (theme)
    "Disable active themes and load THEME."
    (interactive (list (intern (completing-read "Theme: "
                                                (->> (custom-available-themes)
                                                     (-map #'symbol-name))))))
    (mapc #'disable-theme custom-enabled-themes)
    (load-theme theme 'no-confirm)))
#+end_src

** [[https://protesilaos.com/emacs/ef-themes#h:dd9e06f2-eef0-4afe-8a12-b7af5d597108][ef-themes]]

#+begin_src emacs-lisp :tangle no
(use-package ef-themes
  :init
  (setq ef-themes-to-toggle '(ef-bio ef-deuteranopia-dark))
  (setq ef-themes-headings ; read the manual's entry or the doc string
      '((0 variable-pitch light 1.9)
        (1 variable-pitch light 1.8)
        (2 variable-pitch regular 1.7)
        (3 variable-pitch regular 1.6)
        (4 variable-pitch regular 1.5)
        (5 variable-pitch 1.4) ; absence of weight means `bold'
        (6 variable-pitch 1.3)
        (7 variable-pitch 1.2)
        (t variable-pitch 1.1)))
  (setq ef-themes-mixed-fonts t
      ef-themes-variable-pitch-ui t)
  (load-theme 'ef-winter :no-confirm)
  :custom-face
  (ansi-color-red ((t (:background "#440F04"))))
  (ansi-color-bright-red ((t (:background "#A02409"))))
  )
#+end_src

** Base-16

#+begin_src emacs-lisp :tangle no
(use-package base16-theme
  :init
  (load-theme 'base16-default-dark t))
#+end_src

** [[https://github.com/greduan/emacs-theme-gruvbox][gruvbox]]

#+begin_src emacs-lisp :tangle no
(use-package gruvbox-theme
  :init
  (load-theme 'gruvbox-dark-hard :no-confirm)
  )
#+end_src

** Catppuccin

#+begin_src emacs-lisp :tangle no
(setq catppuccin-flavor 'mocha)
(load-theme 'catppuccin t)
#+end_src

* Packages bundled with Emacs
** =adaptive-wrap=

A minor mode which sets the wrap-prefix property on the fly so that single-long-line paragraphs get word-wrapped in a way similar to what you'd get with M-q using adaptive-fill-mode, but without actually changing the buffer's text.

#+begin_src emacs-lisp
(use-package adaptive-wrap
  :commands (adaptive-wrap-prefix-mode))
#+end_src

** =compile=

Do not ask me to save files before compiling, or kill a previous compilation. Also scroll to the end of the compilation buffer when it is opened.

Enable ANSI colors for compilation buffers.

=eat-compilation-start= taken from [[https://codeberg.org/akib/emacs-eat/issues/33][here]], but had to modify it to invoke =compilation-mode-hook=.

#+begin_src emacs-lisp
(use-package compile
  :preface
  (defun eat-compilation-start (command &optional mode name-function highlight-regexp continue)
    (let ((name-of-mode "compilation")
          (dir default-directory)
          outbuf)
      (if (or (not mode) (eq mode t))
          (setq mode #'compilation-minor-mode)
        (setq name-of-mode (replace-regexp-in-string "-mode\\'" "" (symbol-name mode))))
      (with-current-buffer
          (setq outbuf
                (get-buffer-create
                 (compilation-buffer-name name-of-mode mode name-function)))
        (setq default-directory dir)
        (setq buffer-read-only nil)
        (erase-buffer)
        (compilation-insert-annotation
         "-*- mode: " name-of-mode
         "; default-directory: "
         (prin1-to-string (abbreviate-file-name default-directory))
         " -*-\n")
        (compilation-insert-annotation
         (format "%s started at %s\n\n"
                 mode-name
	         (substring (current-time-string) 0 19))
         command "\n")
        (eat-mode)
        (eat-exec outbuf "*compile*" shell-file-name nil (list "-lc" command))
        (run-hook-with-args 'compilation-start-hook (get-buffer-process outbuf))
        (eat-emacs-mode)
        (funcall mode)
        (run-mode-hooks 'compilation-mode-hook)
        (setq next-error-last-buffer outbuf)
        (display-buffer outbuf '(nil (allow-no-window . t)))
        (when-let (w (get-buffer-window outbuf))
           (set-window-start w (point-min)))
        )))

  (defun get-compilation-buffer ()
    (catch 'found
      (dolist (buf (buffer-list))
        (if (string-match "\\*compilation\\*" (buffer-name buf))
            (throw 'found buf)))))

  (defun nl/show-compilation ()
    (interactive)
    (let ((compile-buf (get-compilation-buffer)))
      (if compile-buf
          (switch-to-buffer-other-window compile-buf)
        (call-interactively 'compile))))

  (defun nl/colorize-compilation-buffer ()
    (let ((inhibit-read-only t))
      (ansi-color-apply-on-region (point-min) (point-max)))
    )

  (defun nl/compile-hook ()
    (hl-line-mode)
    (setq-local scroll-conservatively most-positive-fixnum
                scroll-margin 0))

  :hook ((compilation-mode . nl/compile-hook)
         (compilation-filter . nl/colorize-compilation-buffer))
  :custom
  (compilation-ask-about-save nil)
  (compilation-always-kill t)
  (compilation-max-output-line-length nil)
  (compilation-scroll-output 'first-error)
  ;;:config
  ;;(advice-add #'compilation-start :override #'eat-compilation-start)
  )

#+end_src

*** [[https://codeberg.org/ideasman42/emacs-fancy-compilation][emacs-fancy-compilation]]

not required anymore.

A minimalist package that enhances compilation-mode.

#+begin_src emacs-lisp :tangle no
(use-package fancy-compilation
  :commands (fancy-compilation-mode))

(with-eval-after-load 'compile
  (fancy-compilation-mode))
#+end_src

** =css-mode=

#+begin_src emacs-lisp :tangle no
(use-package css-mode
  :preface
  (defun nl/css-mode-hook ()
    (lsp-deferred))
  :hook (css-mode . nl/css-mode-hook)
  )
#+end_src

** =scss-mode=

- was getting this error: =flymake-allowed-file-name-masks is void=

  fixed it by looking at this issue: https://github.com/haskell/haskell-mode/issues/1825

  and adding =(require 'flymake-proc)= to the =:preface= section.

#+begin_src emacs-lisp
(use-package scss-mode
  :mode "\\.scss\\'"
  :preface
  (require 'flymake-proc)
  (defun nl/scss-mode-hook ()
    (lsp-deferred))
  :hook (scss-mode . nl/scss-mode-hook)
  :config
  (setq flymake-allowed-file-name-masks nil)
  )
#+end_src

** =dired=

Make =dired= show directories first.

#+begin_src emacs-lisp
(use-package emacs
  :custom
  (dired-recursive-copies 'always)
  ;; Auto refresh Dired, but be quiet about it
  (global-auto-revert-non-file-buffers t)
  ;; Move files to trash when deleting
  (delete-by-moving-to-trash t)
  (dired-dwim-target t)
  (find-file-visit-truename t)
  :config
  (setq dired-listing-switches "-aBhl --group-directories-first")
  ;; Reuse same dired buffer, to prevent numerous buffers while navigating in dired
  (put 'dired-find-alternate-file 'disabled nil)
  :hook ((dired-mode . dired-hide-details-mode)
         (dired-mode . hl-line-mode)))
#+end_src

** =emacsclient=

#+begin_src emacs-lisp
(use-package edit-server
  :if (display-graphic-p)
  :commands edit-server-start
  :preface
  (defun nl/after-init-hook ()
    (server-start t)
    (edit-server-start t)
    )
  :init
  (if after-init-time
      (edit-server-start)
    (add-hook 'after-init-hook 'nl/after-init-hook)))
#+end_src

** =hl-line=

#+begin_src emacs-lisp
(use-package hl-line
  :commands hl-line-mode)
#+end_src

** =recentf=

Recentf is a minor mode that builds a list of recently opened files. This list is is automatically saved across Emacs sessions.

Prefer saving the history of opened files somewhere other than the default.

#+begin_src emacs-lisp
(use-package recentf
  :init (recentf-mode 1)
  :custom
  (recentf-save-file "~/.emacs.d/etc/recentf")
  (recentf-max-saved-items 100))
#+end_src

** =savehist=

The history of prompts like =M-:= can be saved, but let's change its
save file and history length first. Also save search entries.

#+begin_src emacs-lisp
(setq savehist-additional-variables '(search-ring regexp-search-ring)
      savehist-file "~/.emacs.d/etc/savehist"
      history-length 150)
(savehist-mode 1)
#+end_src

** =saveplace=

Remember position in a file.

#+begin_src emacs-lisp
(use-package saveplace
  :custom
  (save-place-file (locate-user-emacs-file "etc/saveplace" "places"))
  (save-place-forget-unreadable-files nil)
  (save-place-ignore-files-regexp "\\(?:COMMIT_EDITMSG\\|svn-commit\\.tmp\\|config\\.org\\)$")
  ;; activate it for all buffers
  :init
  ;;(setq-default save-place t)
  (save-place-mode t))
#+end_src
** =SQL=

#+begin_src emacs-lisp
(use-package sql
  :preface
  (defun nl/sql-mode-hook ()
    "My SQL Mode configuration"
    (lsp-deferred)
    (flycheck-mode t)
    )
  :hook ((sql-mode . nl/sql-mode-hook))
  )
#+end_src

** =tree sitter=

Had to install TSX tag =v0.20.2= since the latest in the repository cause a parsing failure

#+begin_src emacs-lisp
(use-package treesit-auto
  :config
  (global-treesit-auto-mode))

(use-package tree-sitter
  :ensure tree-sitter-langs
  :init
  (setq treesit-language-source-alist
   '((bash "https://github.com/tree-sitter/tree-sitter-bash")
     (cmake "https://github.com/uyha/tree-sitter-cmake")
     (css "https://github.com/tree-sitter/tree-sitter-css")
     (elisp "https://github.com/Wilfred/tree-sitter-elisp")
     (go "https://github.com/tree-sitter/tree-sitter-go")
     (html "https://github.com/tree-sitter/tree-sitter-html")
     (java "https://github.com/tree-sitter/tree-sitter-java")
     (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
     (json "https://github.com/tree-sitter/tree-sitter-json")
     (make "https://github.com/alemuller/tree-sitter-make")
     (markdown "https://github.com/ikatyang/tree-sitter-markdown")
     ;; (php "https://github.com/tree-sitter/tree-sitter-php")
     (php "https://github.com/tree-sitter/tree-sitter-php" "v0.23.10" "php/src")
     (python "https://github.com/tree-sitter/tree-sitter-python")
     (toml "https://github.com/tree-sitter/tree-sitter-toml")
     ;; (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
     (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "v0.23.2" "tsx/src")
     (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
     (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
  (setq major-mode-remap-alist
        '((bash-mode . bash-ts-mode)
          (js2-mode . js-ts-mode)
          (typescript-mode . typescript-ts-mode)
          (json-mode . json-ts-mode)
          (css-mode . css-ts-mode)
          (java-mode . java-ts-mode)
          (php-mode . php-ts-mode)
          (python-mode . python-ts-mode)
          (yaml-mode . yaml-ts-mode))
        )
  (setq treesit-auto-fallback-alist
      '((toml-ts-mode . conf-toml-mode)
        ;; I don't actually know if the future tree-sitter mode for HTML will be
        ;; called html-ts-mode or mhtml-ts-mode, but if it's the former I'd include this
        (html-ts-mode . mhtml-mode)
        ;; See the note in their README: https://github.com/emacs-typescript/typescript.el#a-short-note-on-development-halt
        (typescript-ts-mode . nil)
        (tsx-ts-mode . nil)))
  (add-hook 'tree-sitter-after-on-hook #'tree-sitter-hl-mode)
  )
#+end_src

Bulk install all tree sitter language:

#+begin_src emacs-lisp :tangle no
(mapc #'treesit-install-language-grammar (mapcar #'car treesit-language-source-alist))
#+end_src

** =winner-mode=

Window management. ~C-c left (winner-undo)~ undoes the last window configuration change. Redo the changes using ~C-c right (winner-redo)~. Also move from window to window using Meta and the direction keys.

#+begin_src emacs-lisp
(use-package winner
  :init
  (winner-mode))
#+end_src

* Elpa packages
** [[https://github.com/wyuenho/all-the-icons-dired][all-the-icons-dired]]

Using =nerd-icons-dired= instead.

#+begin_src emacs-lisp :tangle no
(use-package all-the-icons
  :if window-system)

;; now done in treemacs-icons-dired config
(use-package all-the-icons-dired
  ;; M-x all-the-icons-install-fonts
  :hook (dired-mode . all-the-icons-dired-mode)
  )
#+end_src
** [[https://github.com/abo-abo/ace-window][ace-window]]

A package that uses the same idea from ace-jump-mode for
buffer navigation, but applies it to windows. The default keys are
1-9, but it's faster to access the keys on the home row, so that's
what I have them set to (with respect to Dvorak, of course).

#+begin_src emacs-lisp
(use-package ace-window
  :config
  (setq aw-keys '(?a ?s ?d ?f ?g ?h ?j ?k ?l)))
#+end_src

** [[https://github.com/abo-abo/avy][avy]]

A quick way to jump around text in buffers.

#+begin_src emacs-lisp
(use-package avy
  :bind
  (("C-c SPC" . avy-goto-char)
   ("C-:" . avy-goto-char-timer)))
#+end_src

** [[https://github.com/kickingvegas/casual][casual]]

#+begin_src emacs-lisp
(use-package casual
  :demand t
  :bind
  (:map dired-mode-map ("C-o" . #'casual-dired-tmenu))
  ;; (:map calc-mode-map ("C-o" . #'casual-calc-tmenu))
  ;; (:map bookmark-bmenu-mode-map ("C-o" . #'casual-bookmarks-tmenu))
  :config
  (require 'dired))

(use-package casual-suite)
#+end_src

** [[https://github.com/jordonbiondo/column-enforce-mode][column-enforce-mode]]

#+begin_src emacs-lisp
(use-package column-enforce-mode
  :diminish
  :config
  (setq column-enforce-column 120)
  :hook (progmode-hook . column-enforce-mode))
#+end_src

** [[https://github.com/company-mode/company-mode][company-mode]]

Switched to Corfu.

Complete anything.

#+begin_src emacs-lisp :tangle no
(use-package company
  :diminish company-mode
  :bind
  (:map company-active-map
        ("<tab>" . company-complete-common-or-cycle)
        ("M-/" . company-complete-common)
        ("C-n" . company-select-next)
        ("C-p" . company-select-previous))
  :hook
  ((emacs-lisp-mode . (lambda ()
                        (setq-local company-backends '(company-elisp))))
   (emacs-lisp-mode . company-mode))
  :custom
  (company-dabbrev-downcase nil "Don't downcase returned candidates.")
  (company-show-numbers t "Numbers are helpful.")
  (company-abort-manual-when-too-short t "Be less enthusiastic about completion.")
  :custom-face
  (company-tooltip ((t (:family "FiraCode Nerd Font" :height 100))))
  (company-tooltip-selection ((t (:background "#585b70"))))
  :config
  (setq company-idle-delay 0              ;; no delay no autocomplete
        company-minimum-prefix-length 1
        company-tooltip-limit 20)
  )
#+end_src

** Completing-Read

=consult-buffer=

| Keys  | Description            |
|-------+------------------------|
| b SPC | Narrow to buffers      |
| f SPC | Narrow to recent files |
| m SPC | Narrow to bookmarks    |
| p SPC | Narrow to project      |

*** [[https://github.com/minad/consult][consult]]

#+begin_src emacs-lisp
(use-package consult
  ;; Replace bindings. Lazily loaded due by `use-package'.
  :bind (;; C-c bindings (mode-specific-map)
         ("C-c M-x" . consult-mode-command)
         ("C-c h" . consult-history)
         ("C-c k" . consult-kmacro)
         ("C-c m" . consult-man)
         ("C-c i" . consult-info)
         ([remap Info-search] . consult-info)
         ;; C-x bindings (ctl-x-map)
         ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
         ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
         ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
         ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
         ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
         ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
         ;; Custom M-# bindings for fast register access
         ("M-#" . consult-register-load)
         ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
         ("C-M-#" . consult-register)
         ;; Other custom bindings
         ("M-y" . consult-yank-pop)                ;; orig. yank-pop
         ;; M-g bindings (goto-map)
         ("M-g e" . consult-compile-error)
         ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
         ("M-g g" . consult-goto-line)             ;; orig. goto-line
         ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
         ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
         ("M-g m" . consult-mark)
         ("M-g k" . consult-global-mark)
         ("M-g i" . consult-imenu)
         ("M-g I" . consult-imenu-multi)
         ;; M-s bindings (search-map)
         ("M-s d" . consult-find)
         ("M-s D" . consult-locate)
         ("M-s g" . consult-grep)
         ("M-s G" . consult-git-grep)
         ("M-s r" . consult-ripgrep)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ("M-s k" . consult-keep-lines)
         ("M-s u" . consult-focus-lines)
         ;; Isearch integration
         ("M-s e" . consult-isearch-history)
         :map isearch-mode-map
         ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
         ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
         ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
         ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
         ;; Minibuffer history
         :map minibuffer-local-map
         ("M-s" . consult-history)                 ;; orig. next-matching-history-element
         ("M-r" . consult-history))                ;; orig. previous-matching-history-element

  ;; Enable automatic preview at point in the *Completions* buffer. This is
  ;; relevant when you use the default completion UI.
  :hook (completion-list-mode . consult-preview-at-point-mode)

  ;; The :init configuration is always executed (Not lazy)
  :init

  ;; Optionally configure the register formatting. This improves the register
  ;; preview for `consult-register', `consult-register-load',
  ;; `consult-register-store' and the Emacs built-ins.
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)

  ;; Optionally tweak the register preview window.
  ;; This adds thin lines, sorting and hides the mode line of the window.
  (advice-add #'register-preview :override #'consult-register-window)

  ;; Use Consult to select xref locations with preview
  (setq xref-show-xrefs-function #'consult-xref
        xref-show-definitions-function #'consult-xref)

  ;; Configure other variables and modes in the :config section,
  ;; after lazily loading the package.
  :config

  ;; Optionally configure preview. The default value
  ;; is 'any, such that any key triggers the preview.
  ;; (setq consult-preview-key 'any)
  ;; (setq consult-preview-key "M-.")
  ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
  ;; For some commands and buffer sources it is useful to configure the
  ;; :preview-key on a per-command basis using the `consult-customize' macro.
  (consult-customize
   consult-theme :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file consult-xref
   consult--source-bookmark consult--source-file-register
   consult--source-recent-file consult--source-project-recent-file
   ;; :preview-key "M-."
   :preview-key '(:debounce 0.4 any))

  ;; Optionally configure the narrowing key.
  ;; Both < and C-+ work reasonably well.
  (setq consult-narrow-key "<") ;; "C-+"

  ;; Optionally make narrowing help available in the minibuffer.
  ;; You may want to use `embark-prefix-help-command' or which-key instead.
  ;; (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help)

  ;; By default `consult-project-function' uses `project-root' from project.el.
  ;; Optionally configure a different project root function.
  ;;;; 1. project.el (the default)
  ;; (setq consult-project-function #'consult--default-project--function)
  ;;;; 2. vc.el (vc-root-dir)
  ;; (setq consult-project-function (lambda (_) (vc-root-dir)))
  ;;;; 3. locate-dominating-file
  ;; (setq consult-project-function (lambda (_) (locate-dominating-file "." ".git")))
  ;;;; 4. projectile.el (projectile-project-root)
  (autoload 'projectile-project-root "projectile")
  (setq consult-project-function (lambda (_) (projectile-project-root)))
  ;;;; 5. No project support
  ;; (setq consult-project-function nil)
  )
#+end_src

**** My functions

#+begin_src emacs-lisp
(defun nl/consult-ripgrep-pwd ()
  (interactive)
  (consult-ripgrep (if (buffer-file-name)
                       default-directory
                     dired-directory)))
#+end_src

*** [[https://github.com/gagbo/consult-lsp][consult-lsp]]

#+begin_src emacs-lisp
(use-package consult-lsp
  :after lsp)
#+end_src

*** [[https://gitlab.com/OlMon/consult-projectile][consult-projectile]]

#+begin_src emacs-lisp
(use-package consult-projectile
  :after (consult))
#+end_src

*** [[https://github.com/mohkale/consult-yasnippet][consult-yasnippet]]

#+begin_src emacs-lisp
(use-package consult-yasnippet)
#+end_src

*** [[https://github.com/oantolin/embark][embark]]

- ~M-x embark-collect-snapshot~ - Within an embark session, save results to a buffer

#+begin_src emacs-lisp
(use-package marginalia
  ;; Either bind `marginalia-cycle` globally or only in the minibuffer
  :bind (("M-A" . marginalia-cycle)
         :map minibuffer-local-map
         ("M-A" . marginalia-cycle))
  :init
  (marginalia-mode))

(use-package embark
  :ensure t

  :bind
  (("C-." . embark-act)         ;; pick some comfortable binding
   ("C-;" . embark-dwim)        ;; good alternative: M-.
   ("C-h B" . embark-bindings))  ;; alternative for `describe-bindings'

  :preface

  (defmacro my/embark-ace-action (fn)
    `(defun ,(intern (concat "my/embark-ace-" (symbol-name fn))) ()
       (interactive)
       (with-demoted-errors "%s"
         (require 'ace-window)
         (let ((aw-dispatch-always t))
           (aw-switch-to-window (aw-select nil))
           (call-interactively (symbol-function ',fn))))))

  :init

  ;; Optionally replace the key help with a completing-read interface
  (setq prefix-help-command #'embark-prefix-help-command)

  :config

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))


  (define-key embark-file-map     (kbd "o") (my/embark-ace-action find-file))
  (define-key embark-buffer-map   (kbd "o") (my/embark-ace-action switch-to-buffer))
  (define-key embark-bookmark-map (kbd "o") (my/embark-ace-action bookmark-jump))
  )

;; Consult users will also want the embark-consult package.
(use-package embark-consult
  :ensure t
  :after (embark consult)
  :demand t ; only necessary if you have the hook below
  ;; if you want to have consult previews as you move around an
  ;; auto-updating embark collect buffer
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

*** [[https://github.com/minad/vertico][vertico]]

#+begin_src emacs-lisp
(use-package vertico
  :init
  (vertico-mode)

  ;; Grow and shrink the Vertico minibuffer
  ;; (setq vertico-resize t)

  ;; Optionally enable cycling for `vertico-next' and `vertico-previous'.
  (setq vertico-cycle t)
  :config
  (vertico-multiform-mode 1)
  )

;; Use the `orderless' completion style.
;; Enable `partial-completion' for file path expansion.
;; You may prefer to use `initials' instead of `partial-completion'.
(use-package orderless
  :init
  (setq completion-styles '(orderless basic)
        ;;completion-category-defaults nil
        completion-category-overrides '((file (styles partial-completion)))))

;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
  :init
  (savehist-mode))

;; A few more useful configurations...
(use-package emacs
  :init
  ;; Add prompt indicator to `completing-read-multiple'.
  ;; Alternatively try `consult-completing-read-multiple'.
  (defun crm-indicator (args)
    (cons (concat "[CRM] " (car args)) (cdr args)))
  (advice-add #'completing-read-multiple :filter-args #'crm-indicator)

  ;; Do not allow the cursor in the minibuffer prompt
  (setq minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

  ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
  ;; Vertico commands are hidden in normal buffers.
  ;; (setq read-extended-command-predicate
  ;;       #'command-completion-default-include-p)

  ;; Enable recursive minibuffers
  (setq enable-recursive-minibuffers t)
  :custom
  (frame-background-mode 'dark)
  :custom
  (mapc 'frame-set-background-mode (frame-list)))

(use-package vertico-posframe
  :ensure t
  :custom
  (vertico-posframe-parameters
   '((left-fringe . 8)
     (right-fringe . 8))))
#+end_src

** [[https://github.com/minad/corfu][corfu]]

#+begin_src emacs-lisp
(use-package corfu
  :preface
  (defun corfu-lsp-setup ()
    (setq-local completion-styles '(orderless)
                completion-category-defaults nil))
  :hook (lsp-mode . corfu-lsp-setup)
  ;; Optional customizations
  :custom
  (corfu-cycle t)                ;; Enable cycling for `corfu-next/previous'
  (corfu-auto t)                 ;; Enable auto completion
  ;; (corfu-separator ?\s)          ;; Orderless field separator
  ;; (corfu-quit-at-boundary nil)   ;; Never quit at completion boundary
  ;; (corfu-quit-no-match nil)      ;; Never quit, even if there is no match
  ;; (corfu-preview-current nil)    ;; Disable current candidate preview
  ;; (corfu-preselect 'prompt)      ;; Preselect the prompt
  ;; (corfu-on-exact-match nil)     ;; Configure handling of exact matches
  ;; (corfu-scroll-margin 5)        ;; Use scroll margin

  ;; Enable Corfu only for certain modes.
  ;; :hook ((prog-mode . corfu-mode)
  ;;        (shell-mode . corfu-mode)
  ;;        (eshell-mode . corfu-mode))

  ;; Recommended: Enable Corfu globally.  This is recommended since Dabbrev can
  ;; be used globally (M-/).  See also the customization variable
  ;; `global-corfu-modes' to exclude certain modes.
  :init
  (global-corfu-mode))

;; A few more useful configurations...
(use-package emacs
  :init
  ;; TAB cycle if there are only few candidates
  (setq completion-cycle-threshold 3)

  ;; Enable indentation+completion using the TAB key.
  ;; `completion-at-point' is often bound to M-TAB.
  (setq tab-always-indent 'complete)

  ;; Emacs 30 and newer: Disable Ispell completion function. As an alternative,
  ;; try `cape-dict'.
  (setq text-mode-ispell-word-completion nil)

  ;; Emacs 28 and newer: Hide commands in M-x which do not apply to the current
  ;; mode.  Corfu commands are hidden, since they are not used via M-x. This
  ;; setting is useful beyond Corfu.
  (setq read-extended-command-predicate #'command-completion-default-include-p))
#+end_src

** [[https://elpa.gnu.org/packages/csv-mode.html][csv-mode]]

#+begin_src emacs-lisp
(use-package csv-mode
  :mode "\\.csv\\'")
#+end_src

** [[https://codeberg.org/akib/emacs-eat][emacs-eat]]

- Keys
~C-c C-c~ :: sends a SIGINT (like pressing =Ctrl+C= in a regular terminal).
~C-c C-d~ :: sends an EOF (like pressing =Ctrl+D=).

#+begin_src emacs-lisp
(use-package eat
  :custom-face
  (eat-term-color-0 ((t :foreground "deep sky blue")))
  (eat-term-color-8 ((t :foreground "grey57")))
  :preface
  (defun nl/open-eat-and-run-command (command)
    "Open a new EAT session and run a shell COMMAND."
    (interactive "sCommand to run: ")
    (let ((buffer-name (generate-new-buffer-name "*eat*"))
          (current-prefix-arg "*eat-command*"))
      (call-interactively 'eat)
      (with-current-buffer buffer-name
        (goto-char (point-max))
        (insert command)
        (comint-send-input))))
  :commands eat-mode)
#+end_src

** [[https://github.com/akermu/emacs-libvterm][emacs-libvterm]]

No longer using this. Using [[https://codeberg.org/akib/emacs-eat][emacs-eat]] instead.

#+begin_src emacs-lisp :tangle no
(when (file-directory-p "~/src/github/elisp/emacs-libvterm")
  (use-package vterm
    :load-path "~/src/github/elisp/emacs-libvterm"
    :bind
    (:map vterm-mode-map
          ("M-<right>" . windmove-right)
          ("M-<left>" . windmove-left)
          ("M-<up>" . windmove-up)
          ("M-<down>" . windmove-down))
    :commands vterm vterm-other-window
    :config
    (setq vterm-max-scrollback 10000)))
#+end_src

** ediff
#+begin_src emacs-lisp
(use-package ediff
  :custom
  (ediff-diff-options "-w")
  (ediff-split-window-function 'split-window-horizontally)
  (ediff-window-setup-function 'ediff-setup-windows-plain))
#+end_src
** [[https://github.com/emacs-lsp/dap-mode][dap-mode]]

#+begin_src emacs-lisp :tangle no
(use-package dap-mode
  :after lsp-mode
  ;;:hook ((dap-stopped . (call-interactively #'dap-hydra)))
  :commands (dap-debug)
  :config
  (dap-mode t)
  (dap-ui-mode t)
  ;;(require 'dap-node)
  ;;(require 'dap-java)
  (require 'dap-php)
  (require 'dap-python)
  ;;(require 'dap-lldb)
  (add-hook 'dap-stopped-hook
            (lambda (arg) (call-interactively #'dap-hydra)))
  )
#+end_src

** [[https://github.com/emacs-dashboard/emacs-dashboard][dashboard]]

Using =nerd-icons= or =all-the-icons= slows down init time.

#+begin_src emacs-lisp
(use-package dashboard
  ;; :after nerd-icons
  :init
  (dashboard-setup-startup-hook)
  :custom
  (dashboard-projects-backend 'projectile)
  (dashboard-center-content t)
  ;; (dashboard-icon-type 'nerd-icons)
  ;; (dashboard-set-heading-icons t)
  ;; (dashboard-set-file-icons t)
  :config
  (setq dashboard-items '((recents  . 5)
                          (projects . 5)
                          (bookmarks . 5)
                          (registers . 5)))
  )
#+end_src

** [[https://github.com/alexluigit/dirvish][dirvish]]

Dirvish is an improved version of the Emacs inbuilt package Dired.

Stopped using this package since it does not work well on Emacs 30.

#+begin_src emacs-lisp :tangle no
(use-package dirvish
  :init
  (dirvish-override-dired-mode)
  :custom
  ;; Go back home? Just press `bh'
  (dirvish-bookmark-entries
   '(("h" "~/"                          "Home")
     ("d" "~/Downloads/"                "Downloads")
     ("m" "/mnt/"                       "Drives")
     ("t" "~/.local/share/Trash/files/" "TrashCan"))
     (dirvish-header-line-format '(:left (path) :right (free-space))))
  (dirvish-mode-line-format ; it's ok to place string inside
   '(:left (sort file-time " " file-size symlink) :right (omit yank index)))
  ;; Don't worry, Dirvish is still performant even you enable all these attributes
  (dirvish-attributes '(all-the-icons file-size collapse subtree-state vc-state))
  ;; Maybe the icons are too big to your eyes
  ;; (dirvish-all-the-icons-height 0.8)
  ;; In case you want the details at startup like `dired'
  ;; (dirvish-hide-details nil)
  :config
  ;; (dirvish-peek-mode)
  ;; Dired options are respected except a few exceptions, see *In relation to Dired* section above
  (setq dired-dwim-target t)
  (setq delete-by-moving-to-trash t)
  ;; Enable mouse drag-and-drop files to other applications
  (setq dired-mouse-drag-files t)                   ; added in Emacs 29
  (setq mouse-drag-and-drop-region-cross-program t) ; added in Emacs 29
  ;; Make sure to use the long name of flags when exists
  ;; eg. use "--almost-all" instead of "-A"
  ;; Otherwise some commands won't work properly
  (setq dired-listing-switches
        "-l --almost-all --human-readable --time-style=long-iso --group-directories-first --no-group")
  :bind
  ;; Bind `dirvish|dirvish-side|dirvish-dwim' as you see fit
  (("C-c f" . dirvish-fd)
   :map dired-mode-map ; Dirvish respects all the keybindings in this map
   ("<prior>" . dired-up-directory)
   ;; ("j" . dired-next-line)
   ;; ("k" . dired-previous-line)
   ;; ("l" . dired-find-file)
   ;; ("i" . wdired-change-to-wdired-mode)
   ;; ("." . dired-omit-mode)
   ("b"   . dirvish-bookmark-jump)
   ("f"   . dirvish-file-info-menu)
   ("y"   . dirvish-yank-menu)
   ("N"   . dirvish-narrow)
   ("^"   . dirvish-history-last)
   ("s"   . dirvish-quicksort) ; remapped `dired-sort-toggle-or-edit'
   ("?"   . dirvish-dispatch)  ; remapped `dired-summary'
   ("TAB" . dirvish-subtree-toggle)
   ("SPC" . dirvish-history-jump)
   ("M-n" . dirvish-history-go-forward)
   ("M-p" . dirvish-history-go-backward)
   ("M-l" . dirvish-ls-switches-menu)
   ("M-m" . dirvish-mark-menu)
   ;;("M-f" . dirvish-toggle-fullscreen)
   ;;("M-s" . dirvish-setup-menu)
   ("M-e" . dirvish-emerge-menu)
   ("M-j" . dirvish-fd-jump)))
#+end_src

** [[https://github.com/spotify/dockerfile-mode][dockerfile-mode]]

No longer using this. CLI is good enough.

#+begin_src emacs-lisp :tangle no
(use-package dockerfile-mode
  :mode ("Dockerfile\\'" . dockerfile-mode))
#+end_src

** Git
*** [[https://github.com/magit/magit][magit]]

A great interface for git projects. It's much more pleasant to use than the git interface on the
command line. Use an easy keybinding to access magit.

#+begin_src emacs-lisp
(use-package magit
  :pin melpa
  :bind (("C-x g" . magit-status))
  ;;:hook (magit-mode . magit-todos-mode)
  :config
  (define-key magit-status-mode-map (kbd "q") 'magit-quit-session)
  (setq-default vc-handled-backends '(Git))
  (setq magit-push-always-verify nil

        ;; only use A and B in Ediff
        magit-ediff-dwim-show-on-hunks t)
  (magit-add-section-hook 'magit-status-sections-hook
                          'magit-insert-modules
                          'magit-insert-stashes
                          'append))
#+end_src

**** Full-screen magit

The following code makes magit-status run alone in the frame, and then restores the old window configuration when you quit out of magit.

#+begin_src emacs-lisp
(defadvice magit-status (around magit-fullscreen activate)
  ;;(window-configuration-to-register ?magit-fullscreen)
  (window-configuration-to-register ?z)
  ad-do-it
  (delete-other-windows))

(defun magit-quit-session ()
  "Restores the previous window configuration and kills the magit buffer"
  (interactive)
  (kill-buffer)
  ;;(jump-to-register ?magit-fullscreen))
  (jump-to-register ?z))
#+end_src

**** File log

=M-x magit-log-buffer-file=

*** [[https://github.com/alphapapa/magit-todos][magit-todos]]

#+begin_src emacs-lisp
(use-package magit-todos
  :diminish
  :after magit
  :custom
  (magit-todos-auto-group-items 'always)
  (magit-todos-group-by '(magit-todos-item-keyword magit-todos-item-filename))
  :config
  (magit-todos-mode))
#+end_src

*** [[https://gitlab.com/pidu/git-timemachine][git-timemachine]]

#+begin_src emacs-lisp
(use-package git-timemachine
  :commands git-timemachine)
#+end_src

*** [[https://github.com/syohex/emacs-git-gutter][emacs-git-gutter]]

Uses gutter icons to show extra information about files in a git repository. Gutter Icons indicate inserted, modified or deleted lines.

#+begin_src emacs-lisp
(use-package git-gutter
  :diminish git-gutter-mode
  :hook (prog-mode . git-gutter-mode))
#+end_src

*** [[https://github.com/10sr/git-walktree-el][git-walktree.el]]

Browse Git tree and blob objects

=M-x git-walktree= to open ~git-walktree~ buffer. Prompt user for revision to show.

When current buffer is visiting a file and it exists in the revision, open blob buffer for that file
Otherwise, open tree buffer for default-directory In ~git-walktree~ buffers, following keybinds are defined:

- ~^~ Go up to parent tree object
- ~P~ Move to parent revision
- ~N~ Move to child revision
- ~C~ Checkout current blob or tree object to working directory
- ~G~ Move to another revision (ask user)

Additionally, in tree object buffer:

- ~ENTER~ Visit tree or blob object at point

#+begin_src emacs-lisp
(use-package git-walktree)
#+end_src

*** difftastic

See https://tsdh.org/posts/2022-08-01-difftastic-diffing-with-magit.html

#+begin_src emacs-lisp :tangle no
(defun th/magit--with-difftastic (buffer command)
  "Run COMMAND with GIT_EXTERNAL_DIFF=difft then show result in BUFFER."
  (let ((process-environment
         (cons (concat "GIT_EXTERNAL_DIFF=difft --width="
                       (number-to-string (frame-width)))
               process-environment)))
    ;; Clear the result buffer (we might regenerate a diff, e.g., for
    ;; the current changes in our working directory).
    (with-current-buffer buffer
      (setq buffer-read-only nil)
      (erase-buffer))
    ;; Now spawn a process calling the git COMMAND.
    (make-process
     :name (buffer-name buffer)
     :buffer buffer
     :command command
     ;; Don't query for running processes when emacs is quit.
     :noquery t
     ;; Show the result buffer once the process has finished.
     :sentinel (lambda (proc event)
                 (when (eq (process-status proc) 'exit)
                   (with-current-buffer (process-buffer proc)
                     (goto-char (point-min))
                     (ansi-color-apply-on-region (point-min) (point-max))
                     (setq buffer-read-only t)
                     (view-mode)
                     (end-of-line)
                     ;; difftastic diffs are usually 2-column side-by-side,
                     ;; so ensure our window is wide enough.
                     (let ((width (current-column)))
                       (while (zerop (forward-line 1))
                         (end-of-line)
                         (setq width (max (current-column) width)))
                       ;; Add column size of fringes
                       (setq width (+ width
                                      (fringe-columns 'left)
                                      (fringe-columns 'right)))
                       (goto-char (point-min))
                       (pop-to-buffer
                        (current-buffer)
                        `(;; If the buffer is that wide that splitting the frame in
                          ;; two side-by-side windows would result in less than
                          ;; 80 columns left, ensure it's shown at the bottom.
                          ,(when (> 80 (- (frame-width) width))
                             #'display-buffer-at-bottom)
                          (window-width
                           . ,(min width (frame-width))))))))))))

(defun th/magit-show-with-difftastic (rev)
  "Show the result of \"git show REV\" with GIT_EXTERNAL_DIFF=difft."
  (interactive
   (list (or
          ;; If REV is given, just use it.
          (when (boundp 'rev) rev)
          ;; If not invoked with prefix arg, try to guess the REV from
          ;; point's position.
          (and (not current-prefix-arg)
               (or (magit-thing-at-point 'git-revision t)
                   (magit-branch-or-commit-at-point)))
          ;; Otherwise, query the user.
          (magit-read-branch-or-commit "Revision"))))
  (if (not rev)
      (error "No revision specified")
    (th/magit--with-difftastic
     (get-buffer-create (concat "*git show difftastic " rev "*"))
     (list "git" "--no-pager" "show" "--ext-diff" rev))))

(defun th/magit-diff-with-difftastic (arg)
  "Show the result of \"git diff ARG\" with GIT_EXTERNAL_DIFF=difft."
  (interactive
   (list (or
          ;; If RANGE is given, just use it.
          (when (boundp 'range) range)
          ;; If prefix arg is given, query the user.
          (and current-prefix-arg
               (magit-diff-read-range-or-commit "Range"))
          ;; Otherwise, auto-guess based on position of point, e.g., based on
          ;; if we are in the Staged or Unstaged section.
          (pcase (magit-diff--dwim)
            ('unmerged (error "unmerged is not yet implemented"))
            ('unstaged nil)
            ('staged "--cached")
            (`(stash . ,value) (error "stash is not yet implemented"))
            (`(commit . ,value) (format "%s^..%s" value value))
            ((and range (pred stringp)) range)
            (_ (magit-diff-read-range-or-commit "Range/Commit"))))))
  (let ((name (concat "*git diff difftastic"
                      (if arg (concat " " arg) "")
                      "*")))
    (th/magit--with-difftastic
     (get-buffer-create name)
     `("git" "--no-pager" "diff" "--ext-diff" ,@(when arg (list arg))))))

(transient-define-prefix th/magit-aux-commands ()
  "My personal auxiliary magit commands."
  ["Auxiliary commands"
   ("d" "Difftastic Diff (dwim)" th/magit-diff-with-difftastic)
   ("s" "Difftastic Show" th/magit-show-with-difftastic)])

(transient-append-suffix 'magit-dispatch "!"
  '("#" "My Magit Cmds" th/magit-aux-commands))

(define-key magit-status-mode-map (kbd "#") #'th/magit-aux-commands)
#+end_src
*** [[https://github.com/dandavison/magit-delta][magit-delta]]

#+begin_src emacs-lisp :tangle no
(use-package magit-delta
  :hook (magit-mode . magit-delta-mode))
#+end_src

** [[https://github.com/magnars/expand-region.el][expand-region]]

Expand region increases the selected region by semantic units. Just keep pressing the key until it selects what you want.

#+begin_src emacs-lisp
(use-package expand-region
  :bind
  (("C-=" . er/expand-region)
   ("M-S-<up>" . er/expand-region)
   ("M-S-<down>" . er/contract-region))
  :config
  (setq expand-region-smart-cursor t
        er/enable-subword-mode? nil))
#+end_src

** [[https://github.com/flycheck/flycheck][flycheck]]

Modern on-the-fly syntax checking extension for GNU Emacs.

#+begin_src emacs-lisp
(use-package flycheck
  :commands global-flycheck-mode
  :diminish flycheck-mode
  :commands flycheck-define-checker
  :init
  (global-flycheck-mode)
  :config
  (setq flycheck-standard-error-navigation nil)

  (setq-default flycheck-disabled-checkers
                (append flycheck-disabled-checkers
                        '(javascript-jshint)))

  (setq flycheck-checkers (append flycheck-checkers
                                  '(javascript-eslint))
        flycheck-python-flake8-executable "flake8")
  ;; use eslint with web-mode for jsx files
  (flycheck-add-mode 'javascript-eslint 'tsx-ts-mode)
  (flycheck-add-mode 'javascript-eslint 'web-mode)
  (flycheck-add-mode 'javascript-eslint 'js2-mode)
  (flycheck-add-mode 'javascript-eslint 'js-mode))
#+end_src

** [[https://github.com/nflath/hungry-delete][hungry-delete]]

So that hungry deletion can be used in all modes.

#+begin_src emacs-lisp
(use-package hungry-delete
  :diminish hungry-delete-mode
  :init
  (global-hungry-delete-mode))
#+end_src

** [[https://github.com/abo-abo/hydra][hydra]]

This package can be used to tie related commands into a family of short bindings with a common prefix - a Hydra.

#+begin_src emacs-lisp
(use-package hydra
  :pin melpa
  :after key-chord
  :init
  (use-package cl-lib)
  (use-package lv)
  :custom
  (hydra-hint-display-type 'posframe)
  :config
  ;;(setq hydra-posframe-show-params (plist-put hydra-posframe-show-params :family "Fira Code Retina"))
  (setq hydra-posframe-show-params
        (plist-put hydra-posframe-show-params :family nl/gui-fixed-font-name))

  (defun nl/pull-window ()
    "Pull a window to the window the point is at"
    (interactive)
    (aw--push-window (selected-window))
    (ace-swap-window)
    (aw-flip-window))

  (defun nl/open-buffer-in-other-window ()
    "Open buffer in another window."
    (interactive)
    (let ((pt (point))
          (buf (current-buffer))
          (window (ace-select-window)))
      (set-window-buffer window buf)
      (goto-char pt)
      (recenter-top-bottom 'top)))

  ;; http://oremacs.com/2015/01/29/more-hydra-goodness/

  (defun hydra-universal-argument (arg)
    (interactive "P")
    (setq prefix-arg (if (consp arg)
                         (list (* 4 (car arg)))
                       (if (eq arg '-)
                           (list -4)
                         '(4)))))


   (defhydra hydra-files (:columns 2 :color red)
     "Files hydra"
     ("h" (dired "~/.") "home" :column "System" :color blue)
     ("e" (dired "~/.emacs.d") "Emacs" :color blue)
     ("c" (dired "~/.config") "Config" :color blue)
     ("l" (dired "~/.local") "Local" :color blue)
     ("P" (dired "~/src") "src" :column "Projects" :color blue)
     ("n" (dired "~/src/nordita/norweb-2021") "Norweb" :color blue)
     ("N" (dired "~/src/nordita/norweb-2021-dev") "Norweb-dev" :color blue)
     ("o" (dired "~/src/openTA/openta") "OpenTA" :color blue)
     ("C" (dired "~/home_config") "My config" :column "Mine" :color blue)
     ("S" (dired "~/src/nelson/nlscripts") "My scripts" :color blue)
     ("O" (dired "~/Dropbox/orgfiles") "Org" :color blue)
     )

  (global-set-key (kbd "C-,") 'hydra-files/body)

   (defhydra hydra-window (:color red :idle 0.0)
     "Window hydra"
     ("h" windmove-left "move left" :color red :column "move")
     ("j" windmove-down "move down" :color red)
     ("k" windmove-up "move up" :color red)
     ("l" windmove-right "move right" :color red)
     ("s" ace-swap-window "swap window" :color blue)
     ("p" nl/pull-window "pull window" :color blue)
     ("|" (progn (split-window-right) (windmove-right)) "split right and move" :column "split" :color blue)
     ("_" (progn (split-window-below) (windmove-down)) "split below and move" :color blue)
     ("v" split-window-right "split right" :color blue)
     ("x" split-window-below "split below" :color blue)
     ("u" winner-undo "winner undo" :column "winner / ace " :color blue)
     ("r" winner-redo "winner redo") ;;Fixme, not working?
     ("a" ace-window "ace select window" :exit t)
     ("f" new-frame "new frame" :column "frame" :exit t)
     ("o" nl/open-buffer-in-other-window "open in other window" :exit t)
     ("da" ace-delete-window "ace delete window" :column "delete" :color blue)
     ("dw" delete-window "delete window")
     ("db" kill-this-buffer "kill this buffer" :color blue)
     ("df" delete-frame "delete frame" :exit t)
     ("q" nil "quit"))

  (key-chord-define-global "YY" 'hydra-window/body)

  (defhydra hydra-buffer (:color blue :columns 3)
     "Buffer hydra"
     ("n" next-buffer "next" :color red)
     ;;("b" helm-mini "switch")
     ("B" ibuffer "ibuffer")
     ("p" previous-buffer "prev" :color red)
     ("C-b" buffer-menu "buffer menu")
     ("d" kill-this-buffer "delete" :color red)
     ;; don't come back to previous buffer after delete
     ("D" (progn (kill-this-buffer) (next-buffer)) "Delete" :color red)
     ("s" save-buffer "save" :color red))

  (key-chord-define-global "zz" 'hydra-buffer/body)

  (defhydra hydra-goto-line (goto-map "")
     "goto-line"
     ("g" consult-goto-line "go")
     ("m" set-mark-command "mark" :bind nil)
     ("q" nil "quit"))

  (global-set-key (kbd "M-g M-g") 'hydra-goto-line/body)

  (defun toggle-window-split ()
    (interactive)
    (if (= (count-windows) 2)
        (let* ((this-win-buffer (window-buffer))
	       (next-win-buffer (window-buffer (next-window)))
	       (this-win-edges (window-edges (selected-window)))
	       (next-win-edges (window-edges (next-window)))
	       (this-win-2nd (not (and (<= (car this-win-edges)
					   (car next-win-edges))
				       (<= (cadr this-win-edges)
					   (cadr next-win-edges)))))
	       (splitter
	        (if (= (car this-win-edges)
		       (car (window-edges (next-window))))
		    'split-window-horizontally
		  'split-window-vertically)))
	  (delete-other-windows)
	  (let ((first-win (selected-window)))
	    (funcall splitter)
	    (if this-win-2nd (other-window 1))
	    (set-window-buffer (selected-window) this-win-buffer)
	    (set-window-buffer (next-window) next-win-buffer)
	    (select-window first-win)
	    (if this-win-2nd (other-window 1))))))

  (global-set-key
   (kbd "C-c w")
   (defhydra hydra-windows-nav (:color red)
     ("s" shrink-window-horizontally "shrink horizontally" :column "Sizing")
     ("e" enlarge-window-horizontally "enlarge horizontally")
     ("S" shrink-window "shrink vertically")
     ("E" enlarge-window "enlarge vertically")
     ("b" balance-windows "balance window height")
     ("m" maximize-window "maximize current window")
     ("M" minimize-window "minimize current window")
     ("h" split-window-below "split horizontally" :column "Split management")
     ("v" split-window-right "split vertically")
     ("d" delete-window "delete current window")
     ("x" delete-other-windows "delete-other-windows")
     ("z" ace-window "ace window" :color blue :column "Navigation")
     ("h" windmove-left "← window")
     ("j" windmove-down "↓ window")
     ("k" windmove-up "↑ window")
     ("l" windmove-right "→ window")
     ("r" toggle-window-split "rotate windows") ; Located in utility functions
     ("q" nil "quit menu" :color blue :column nil))))
#+end_src

*** Aligning things

Align by colons (handy for JavaScript), align by commas, and align by equal signs.

Borrowed from:

http://danconnor.com/post/5028ac91e8891a000000111f/align_and_columnize_key_value_data_in_emacs

#+begin_src emacs-lisp
(defun nl/align-regexp-command (regexp)
  "Align region using the provided REGEXP."
  (interactive (list (read-string "Align regex: ")))
  (if (use-region-p)
      (align-regexp (region-beginning) (region-end) regexp 1 1 t)
    (message "No active region to align.")))

(defun align-colons (beg end)
  (interactive "r")
  (nl/align-regexp-command ":\\(\\s-+\\)"))

(defun align-commas (beg end)
  (interactive "r")
  (align-regexp beg end ",\\(\\s-+\\)" 1 1 t))

(defun align-equals (beg end)
  (interactive "r")
  (align-regexp beg end "\\(\\s-*\\)=" 1 1 t))

(defun align-dollar-sign ()
  (interactive)
  (nl/align-regexp-command "\\(\\s-*\\)\\$"))

(defun align-parameters (beg end)
  (interactive "r")
  (align-regexp beg end "\\w+\\(\\s-*\\)\\w+,?" 1 1 t))

(defhydra hydra-nl-align (:hint nil)
  (":" align-colons "colons" :color blue :column "Align things")
  ("," align-commas "commas" :color blue)
  ("=" align-equals "equals" :color blue)
  ("$" align-dollar-sign "dollar sign" :color blue)
  ("p" align-parameters "parameters" :color blue))
#+end_src

** [[https://gitlab.com/emacs-stuff/indent-tools/][indent-tools]]

Indent, move around and act on code based on indentation.

#+begin_src emacs-lisp
(use-package indent-tools
  :bind (("C-c >" . indent-tools-hydra/body)))
#+end_src

** Java

#+begin_src emacs-lisp
(use-package cc-mode
  :mode (("\\.h\\(h?\\|xx\\|pp\\)\\'" . c++-mode)
         ("\\.java\\'"                . java-ts-mode)
         )
  :hook
  (java-ts-mode . nl/java-mode-hook)
  :preface
  (use-package nl-java-project :demand :load-path "~/.emacs.d/lisp")
  (defun nl/java-mode-hook ()
    "My Java mode configuration."
    (lsp-deferred)
    (flycheck-mode t)
    (subword-mode +1)
    (setq indent-tabs-mode nil
          c-basic-offset 4
          lsp-java-format-settings-url (format "%s/eclipse-java-google-style.xml" (projectile-project-root)))

    (setq projectile-find-dir-includes-top-level t
          projectile-test-suffix-function (lambda (project-type) "" "Test")
          projectile-create-missing-test-files t
          )
    )
    :config
    (projectile-update-project-type 'maven :test-suffix "Test"))
#+end_src

*** lsp-java

#+begin_src emacs-lisp
(use-package lsp-java
  :hook (java-ts-mode . lsp)
  :custom
  (lsp-java-compile-null-analysis-mode "automatic")
  (lsp-java-format-enabled nil)
  ;;(lsp-java-save-actions-organize-imports t)
  )
#+end_src
** [[https://github.com/minad/jinx][jinx]]

Jinx is a fast just-in-time spell-checker for Emacs.

#+begin_src emacs-lisp
(use-package jinx
  :hook (emacs-startup . global-jinx-mode)
  :bind (("M-$" . jinx-correct)
         ("C-M-$" . jinx-languages))
  :config
  (setq jinx-languages "en_CA")
  (add-to-list 'vertico-multiform-categories
               '(jinx grid (vertico-grid-annotate . 20)))
  )
#+end_src
** [[https://github.com/emacsorphanage/key-chord][key-chord]]

See =init.el=.
** [[https://github.com/jschaf/emacs-lorem-ipsum][lorem-ipsum]]

Add filler lorem ipsum text to Emacs.

#+begin_src emacs-lisp
(use-package lorem-ipsum)
#+end_src

** [[https://github.com/emacs-lsp/lsp-docker][lsp-docker]]

#+begin_src emacs-lisp :tangle no
(use-package lsp-docker
  :init (setq lsp-keymap-prefix "C-c l")
  :config
  (add-to-list 'vertico-multiform-categories
               '(jinx grid (vertico-grid-annotate . 20))))
#+end_src

** [[https://github.com/emacs-lsp/lsp-mode][lsp-mode]]

#+begin_src emacs-lisp
(use-package which-key
  :diminish
  :config
  (which-key-mode))

(use-package lsp-mode
  ;;:load-path "~/src/github/elisp/lsp-mode"
  :pin melpa
  :commands (lsp lsp-deferred)
  :custom
  (lsp-keymap-prefix "C-c l")
  (lsp-enable-snippet t)
  (lsp-enable-file-watchers nil)
  (lsp-pyls-plugins-pycodestyle-max-line-length 120)
  (lsp-intelephense-php-version "8.3")
  (lsp-intelephense-format-enable nil)
  ;;(setq lsp-response-timeout 25)
  ;; what to use when checking on-save. "check" is default, I prefer clippy
  (lsp-rust-analyzer-cargo-watch-command "clippy")
  (lsp-eldoc-render-all t)
  (lsp-idle-delay 0.6)
  ;; enable / disable the hints as you prefer:
  (lsp-rust-analyzer-server-display-inlay-hints t)
  (lsp-rust-analyzer-display-lifetime-elision-hints-enable "skip_trivial")
  (lsp-rust-analyzer-display-chaining-hints t)
  (lsp-rust-analyzer-display-lifetime-elision-hints-use-parameter-names nil)
  (lsp-rust-analyzer-display-closure-return-type-hints t)
  (lsp-rust-analyzer-display-parameter-hints nil)
  (lsp-rust-analyzer-display-reborrow-hints nil)
  :config
  (lsp-enable-which-key-integration t)
  (setq read-process-output-max (* 1024 1024)
        lsp-prefer-capf t
        lsp-idle-delay 0.5
        lsp-pyls-plugins-flake8-enabled t
        lsp-completion-provider :none
        ;; lsp-log-io t
        ;; lsp-ensabled-clients '(intelephense)
        )
  (setq lsp-clients-angular-language-server-command
        '("node"
          "/home/nelson/.nvm/versions/node/v16.16.0/lib/node_modules/@angular/language-server"
          "--ngProbeLocations"
          "/home/nelson/.nvm/versions/node/v16.16.0/lib/node_modules"
          "--tsProbeLocations"
          "/home/nelson/.nvm/versions/node/v16.16.0/lib/node_modules"
          "--stdio"))
  (lsp-register-custom-settings
   '(("pyls.plugins.pyls_mypy.enabled" t t)
     ("pyls.plugins.pyls_mypy.live_mode" nil t)
     ("pyls.plugins.pyls_black.enabled" t t)
     ("pyls.plugins.pyls_isort.enabled" t t))))

(use-package lsp-ui
  ;; :load-path "~/src/github/elisp/lsp-ui"
  :hook
  (lsp-mode . lsp-ui-mode)
  ;;(lsp-ui-doc-frame-hook . nl-lsp-ui-doc-hook)
  :commands lsp-ui-mode
  :bind (:map lsp-ui-mode-map
              ([remap xref-find-definitions] . lsp-ui-peek-find-definitions)
              ([remap xref-find-references] . lsp-ui-peek-find-references)
              ([f10] . lsp-ui-sideline-toggle-symbols-info))
  :custom-face
  (lsp-ui-peek-peek ((t :background "gray30")))
  (lsp-ui-peek-highlight ((t :foreground "gray60" :background "gray20")))
  ;;(header-line ((t (:background "gray20"))))
  (lsp-ui-doc-background ((t :background "gray30")))
  (lsp-ui-doc-url ((t :background "gray30")))
  :custom
  (lsp-ui-doc-text-scale-level 2)
  (lsp-ui-sideline-enable t)
  (lsp-ui-sideline-show-hover nil)
  (lsp-ui-peek-enable nil)
  (flycheck-add-next-checker 'lsp-ui 'typescript-tslint)
  :config
  ;; (add-hook 'lsp-ui-doc-frame-hook
  ;;           (lambda (frame _w)
  ;;             (set-face-attribute 'default nil :family nl/gui-variable-font-name :height 180)))
  (setq lsp-ui-flycheck-list-position 'bottom
        lsp-ui-doc-enable t
        ;;lsp-ui-doc-show-with-cursor t
        ;;lsp-ui-doc-show-with-mouse t
        lsp-ui-doc-use-childframe t
        lsp-ui-doc-position 'top
        lsp-ui-doc-include-signature t
        lsp-ui-peek-always-show nil
        lsp-ui-peek-list-width 60
        lsp-ui-peek-peek-height 25
        lsp-ui-sideline-diagnostic-max-line-length 80
        lsp-ui-sideline-diagnostic-max-lines 20
        lsp-eldoc-enable-hover nil)
  (set-face-attribute 'header-line nil
                      :background "gray20"
                      :foreground "white"
                      :box '(:line-width 1 :color "#353644")
                      :height 0.7
                      :overline nil
                      :height 120
                      :inherit 'variable-pitch)
  )
#+end_src

** [[https://github.com/immerrr/lua-mode][lua-mode]]

#+begin_src emacs-lisp
(use-package lua-mode
  :mode (("\\.lua\\'" . lua-mode)))
#+end_src

** [[https://github.com/defunkt/markdown-mode][markdown-mode]]

#+begin_src emacs-lisp
(use-package markdown-mode
  :commands (markdown-mode gfm-mode)
  :mode (("README\\.md\\'" . gfm-mode)
         ("\\.markdown\\'" . markdown-mode)
         ("\\.md\\'"       . gfm-mode))
  :hook
  (markdown-mode . (lambda ()
                     (auto-fill-mode -1)
                     (setq adaptive-wrap-extra-indent 1)
                     (adaptive-wrap-prefix-mode)
                     ))
  (markdown-mode . variable-pitch-mode)
  (markdown-mode . visual-line-mode)
  :config
  (setq markdown-command "pandoc")
  (set-face-attribute 'markdown-code-face
                      nil
                      :family nl/gui-fixed-font-name
                      :background "#303030"
                      :weight 'normal
                      :height 0.8)
  (set-face-attribute 'markdown-inline-code-face nil :family nl/gui-fixed-font-name)
  (set-face-attribute 'markdown-bold-face nil :family nl/gui-variable-font-name)
  (set-face-attribute 'markdown-italic-face nil :family nl/gui-variable-font-name)
  (set-face-attribute 'markdown-list-face nil :family nl/gui-variable-font-name :height 1.3)
  (set-face-attribute 'markdown-header-face-1 nil :family nl/gui-variable-font-name :height 1.9)
  (set-face-attribute 'markdown-header-face-2 nil :family nl/gui-variable-font-name :height 1.7)
  (set-face-attribute 'markdown-header-face-3 nil :family nl/gui-variable-font-name :height 1.5)
  (set-face-attribute 'markdown-header-face-4 nil :family nl/gui-variable-font-name :height 1.4)
  (set-face-attribute 'markdown-header-face-5 nil :family nl/gui-variable-font-name :height 1.3)
  (set-face-attribute 'markdown-header-face-6 nil :family nl/gui-variable-font-name :height 1.2)
  (set-face-attribute 'markdown-header-face nil :family nl/gui-variable-font-name :height 1.1)
  (set-face-attribute 'markdown-header-delimiter-face nil :family nl/gui-variable-font-name :height 0.8))
#+end_src

** [[https://github.com/ancane/markdown-preview-mode][markdown-preview-mode]]

#+begin_src emacs-lisp
(use-package markdown-preview-mode
  :custom
  (markdown-preview-http-port 9090)
  :config
  (setq markdown-preview-stylesheets
        (list
         ;; "https://raw.githubusercontent.com/richleland/pygments-css/master/emacs.css"
         "http://thomasf.github.io/solarized-css/solarized-light.min.css"
         )))
#+end_src

** [[https://github.com/emacsfodder/move-text][move-text]]

MoveText allows you to move the current line using ~M-S-up~ / ~M-S-down~ (or any other bindings you choose) if a region is marked, it will move the region instead.

Modified the bindings to coincide with the ones used in =org-mode=.

#+begin_src emacs-lisp
(use-package move-text
  :bind (("M-S-<up>" . move-text-up)
         ("M-S-<down>" . move-text-down)))
#+end_src

** [[https://github.com/magnars/multiple-cursors.el][multiple-cursors]]

Sometimes you end up with cursors outside of your view. You can scroll the screen to center on each cursor with ~C-v~ and ~M-v~.

#+begin_src emacs-lisp
(use-package multiple-cursors
  :after selected
  :bind (("C-S-c C-S-c" . mc/edit-lines)
         ("C->"         . mc/mark-next-like-this)
         ("C-<"         . mc/mark-previous-like-this)
         ("C-M->"       . mc/unmark-next-like-this)
         ("C-M-<"       . mc/unmark-previous-like-this)
         ("C-c C-<"     . mc/mark-all-like-this)
         ("C-!"         . mc/mark-next-symbol-like-this)
         ("C-x C-m"     . mc/mark-all-dwim)
         (:map selected-keymap
               ("C-'" . mc/edit-lines)
               ("."   . mc/mark-next-like-this)
               ("<"   . mc/unmark-next-like-this)
               ("C->" . mc/skip-to-next-like-this)
               (","   . mc/mark-previous-like-this)
               (">"   . mc/unmark-previous-like-this)
               ("C-<" . mc/skip-to-previous-like-this)
               ("y"   . mc/mark-next-symbol-like-this)
               ("Y"   . mc/mark-previous-symbol-like-this)
               ("w"   . mc/mark-next-word-like-this)
               ("W"   . mc/mark-previous-word-like-this))))
#+end_src

*
** [[https://github.com/rainstormstudio/nerd-icons.el][nerd-icons]]

#+begin_src emacs-lisp
(use-package nerd-icons
  :custom
  (nerd-icons-font-family "FiraCode Nerd Font")
  )

(use-package nerd-icons-dired
 :load-path "~/src/github/elisp/nerd-icons-dired"
 :hook
 (dired-mode . nerd-icons-dired-mode))
#+end_src
** [[https://github.com/nex3/perspective-el][perspective.el]]

The Perspective package provides multiple named workspaces (or "perspectives") in Emacs, similar to multiple desktops in window managers like Awesome and XMonad, and Spaces on the Mac.

#+begin_src emacs-lisp :tangle no
(use-package perspective
  :after consult
  :bind (("C-x b" . persp-switch-to-buffer*)
         ;;("C-x k" . persp-kill-buffer*)
         ("C-x C-b" . persp-list-buffers))         ; or use a nicer switcher, see below
  :custom
  (persp-show-modestring t)
  (persp-mode-prefix-key (kbd "C-x C-x"))  ; pick your own prefix key here
  :init
  (persp-mode)
  :config
  (consult-customize consult--source-buffer :hidden t :default nil)
  (add-to-list 'consult-buffer-sources persp-consult-source))
#+end_src
** [[https://github.com/jamescherti/outline-indent.el][outline-indent]]

Provides a minor mode that enables code folding and outlining based on indentation levels for various indentation-based text files, such as YAML, Python, and any other indented text files.

#+begin_src emacs-lisp
(use-package outline-indent
  :custom
  (outline-indent-ellipsis " ▼ "))
#+end_src

** PHP
*** [[https://github.com/ejmr/php-mode][php-mode]]

#+begin_src emacs-lisp
(use-package php-mode
  :mode "\\.php\\'"
  :hook
  (php-mode . nl/php-mode-hook)
  (php-ts-mode . nl/php-mode-hook)
  :preface
  (use-package flycheck-phpstan)
  (use-package nl-nordita-php-project :demand :load-path "~/.emacs.d/lisp")

  (defun nl/php-mode-hook ()
    "My PHP mode configuration."
    (require 'flycheck-phpstan)
    (setq php-mode-lineup-cascaded-calls t)
    (flycheck-mode t)
    (subword-mode +1)
    ;;(prettier-mode)
    (add-hook 'before-save-hook 'php-cs-fixer-before-save nil t)
    (when buffer-file-name
      (let ((nl-is-nordita-project (string-match-p "nordita" buffer-file-name)))
        (when nl-is-nordita-project
          (nl-nordita-project-settings))
        (unless nl-is-nordita-project
          (nl-php-project-settings))
        )))

  (defun nl-php-project-settings ()
    ;; this style is based on the symfony2 style
    ;;(php-set-style "nl/php")
    (lsp-deferred))

  (defun nl-nordita-project-settings ()
    "Nordita's PHP mode configuration."
    ;;(add-hook 'before-save-hook 'nl/php-before-save-hook)
    (lsp)
    ;;(php-set-style "nl/php-nordita")
    (setq php-project-root 'auto
          php-mode-coding-style 'nl/php-nordita
          phpstan-config-file '(root . "phpstan.neon")
          phpstan-memory-limit "1G"
          phpstan-level 6
          projectile-project-install-cmd "composer update"
          projectile-project-test-cmd  "composer host-test"
          create-lockfiles nil
          php-cs-fixer-config-option (concat (projectile-project-root) ".php-cs-fixer.php"))
    (cond ((string= (projectile-project-root) (expand-file-name "~/src/nordita/norweb-2021/"))
           (setq lsp-intelephense-files-exclude
                 (vconcat lsp-intelephense-files-exclude
                          [
                           ;;"public/wire/**" -- if uncommented, then wont be able to jump to definitions
                           ;; "**/FieldtypeCombo/**"
                           ;; "**/FieldtypeFieldsetGroup/**"
                           ;; "**/FieldtypeRepeaterMatrix/**"
                           ;; "**/FieldtypeTextareas/**"
                           ;; "**/FileValidatorSvgSanitizer/**"
                           ;; "**/InputfieldCKEditor/**"
                           "public/wire.old/**"
                           "**/AppApi/**"
                           "**/ProcessHannaCode/**"
                           "**/pw-fieldtype-yaml/**"
                           "**/RockMigrations/**"
                           "**/TracyDebugger/**"
                           ])
                 lsp-intelephense-rename-exclude
                 (vconcat lsp-intelephense-rename-exclude
                          ["public/wire/**"
                           "public/wire.old/**"
                           "**/AppApi/**"
                           "**/FieldtypeCombo/**"
                           "**/FieldtypeFieldsetGroup/**"
                           "**/FieldtypeRepeaterMatrix/**"
                           "**/FieldtypeTextareas/**"
                           "**/FileValidatorSvgSanitizer/**"
                           "**/InputfieldCKEditor/**"
                           "**/ProcessHannaCode/**"
                           "**/pw-fieldtype-yaml/**"
                           "**/RockMigrations/**"
                           "**/TracyDebugger/**"
                           ])
                 lsp-intelephense-php-version "8.2")
           ))
    )

  ;; this style is based on the symfony2 style
  (c-add-style
   "nl/php"
   '("php"
     (c-basic-offset . 2)
     (indent-tabs-mode . nil)
     (c-offsets-alist . ((statement-cont . php-lineup-hanging-semicolon)))
     (c-indent-comments-syntactically-p . t)
     (fill-column . 120)
     (require-final-newline . t)))

  ;; see https://github.com/taksatou/dotfiles/blob/037e22d7a31112321b92e11bcbd871b8e2acbc9c/.emacs.d/my/my-codingstyles.el
  (c-add-style
   "nl/php-nordita"
   '("php"
     (c-set-style "k&r")
     (c-basic-offset . 4)
     (indent-tabs-mode . nil)
     (c-offsets-alist . ((defun-open            . 0)
                         (defun-close           . 0)
                         (defun-block-intro     . +)
                         (topmost-intro         . 0)
                         (topmost-intro-cont    . c-lineup-topmost-intro-cont)
                         (block-open            . 0)
                         (block-close           . 0)
                         (statement             . 0)
                         (statement-cont        . +)
                         (statement-block-intro . +)
                         (statement-case-intro  . +)
                         (statement-case-open   . 0)
                         (substatement          . +)
                         (substatement-open     . 0)
                         (case-label            . +)
                         (comment-intro         . (c-lineup-knr-region-comment c-lineup-comment))
                         (arglist-intro         . +)
                         (arglist-cont          . (c-lineup-gcc-asm-reg 0))
                         (arglist-cont-nonempty . +)
                         (arglist-close         . 0)
                         ))
     (c-indent-comments-syntactically-p . t)
     (php-mode-lineup-cascaded-calls . nil)
     (show-trailing-whitespace . nil)
     (fill-column . 120)
     (require-final-newline . t)))
  )
#+end_src

*** [[https://github.com/nlamirault/phpunit.el][php-unit]]

#+begin_src emacs-lisp
(use-package phpunit
  :after (php-mode)
  :bind (:map php-mode-map
              ("C-c , t" . phpunit-current-test)
              ("C-c , c" . phpunit-current-class)
              ("C-c , p" . phpunit-current-project))
  :init
  (push `(php-unit-error-regexp
          ,(rx (group-n 1 "/" (one-or-more (or "/" "-" alnum)) ".php")
               ":" (group-n 2 (one-or-more digit)))
          1 2)
        compilation-error-regexp-alist-alist)
  ;; (push `(php-error-regexp
  ;;         ,(rx line-start
  ;;              (zero-or-more "Trace:" space)
  ;;              "#" (one-or-more digit)
  ;;              (zero-or-more space)
  ;;              (group-n 1 (one-or-more (not (in space "(" "\n"))))
  ;;              "(" (group-n 2 (one-or-more digit))
  ;;              (zero-or-more not-newline))
  ;;         1 2)
  ;;       compilation-error-regexp-alist-alist)
  (push 'php-unit-error-regexp compilation-error-regexp-alist)
  ;; remove the following false positives
  (assq-delete-all 'cucumber compilation-error-regexp-alist-alist)
  (assq-delete-all 'cucumber compilation-error-regexp-alist)
  :custom
  (phpunit-arg "--stderr --debug"))
#+end_src

*** [[https://github.com/OVYA/php-cs-fixer][php-cs-fixer]]

Allows the Emacs editor to fix most issues in PHP code when you want to follow the coding standards PSR-1 and PSR-2.

#+begin_src emacs-lisp
(use-package php-cs-fixer
  :after php-mode
    :load-path "~/src/github/elisp/php-cs-fixer"
  :commands (php-cs-fixer-fix php-cs-fixer-before-save))
#+end_src

** prog-mode

#+begin_src emacs-lisp
(use-package prog-mode
  :ensure nil
  :preface
  (defun nl/prog-mode-hook ()
    (display-line-numbers-mode)
    (flyspell-prog-mode))
  :hook
  (prog-mode . nl/prog-mode-hook))
#+end_src

** [[https://github.com/bbatsov/projectile][projectile]]

Project navigation and management library for Emacs.

#+begin_src emacs-lisp
(use-package projectile
  :diminish projectile-mode
  :bind-keymap ("C-c p" . projectile-command-map)
  :bind (:map projectile-command-map ("f" . consult-projectile))
  :init (projectile-mode +1)
  :config
  ;; tramp-fix: https://github.com/syl20bnr/spacemacs/issues/11381
  ;; (defadvice projectile-project-root (around ignore-remote first activate)
  ;;   (unless (file-remote-p default-directory) ad-do-it))

  (setq projectile-indexing-method 'alien
        projectile-remember-window-configs nil
        projectile-switch-project-action 'projectile-dired
        projectile-completion-system 'default
        projectile-enable-caching nil
        projectile-create-missing-test-files t
        projectile-mode-line "Projectile"
        projectile-generic-command
        (if (executable-find "fdfind")
            "fdfind . -0 --type f --color=never"
          "find . -type f -print0 | cut -c3-"))

  (def-projectile-commander-method ?d
    "Open project root in dired."
    (projectile-dired)))
#+end_src

** [[https://github.com/tumashu/posframe][posframe]]

Posframe can pop up a frame at point, this posframe is a child-frame connected to its root window’s buffer.

#+begin_src emacs-lisp
(use-package posframe
  :pin melpa
  :init
  (setq x-gtk-resize-child-frames 'resize-mode))
#+end_src

** [[https://github.com/jscheid/prettier.el][prettier]]

Reformat your code by running Prettier with minimal overhead, by request or transparently on file save.

Had to disable prettier for *css-mode* because syntax highlighting when exporting to HTML in org-mode did not work.

#+begin_src emacs-lisp
(use-package prettier
  :diminish
  :hook ((tsx-ts-mode . prettier-mode)
         (typescript-ts-mode . prettier-mode)
         ;;(js-mode . prettier-mode)
         (json-mode . prettier-mode)
         ;;(css-mode . prettier-mode)
         (css-mode . prettier-mode)
         (yaml-mode . prettier-mode)))
#+end_src

** [[https://protesilaos.com/emacs/pulsar][pulsar]]

Pulse highlight line on demand or after running select functions

#+begin_src emacs-lisp
(use-package pulsar
  :bind (("C-c l p" . pulsar-pulse-line)
         ("C-c l h" . pulsar-highlight-line))
  :init
  (pulsar-global-mode 1)
  :config
  (setq pulsar-pulse t)
  (setq pulsar-delay 0.055)
  (setq pulsar-iterations 10)
  (setq pulsar-face 'pulsar-magenta)
  (setq pulsar-highlight-face 'pulsar-yellow))

#+end_src

** Python
*** [[https://github.com/scop/emacs-ruff-format][ruff-format]]

#+begin_src emacs-lisp
(use-package ruff-format
  :preface
  (defun nl/python-hook ()
    (require 'ruff-format)
    (lsp-deferred)
    (ruff-format-on-save-mode))
  :hook
  (python-ts-mode . nl/python-hook)
  :config
  (setq ruff-format-command "ruff"))
#+end_src

*** [[https://github.com/jorgenschaefer/pyvenv][pyvenv.el]]

#+begin_src emacs-lisp
(use-package pyvenv)
#+end_src

*** lsp-pyright

Using ruff now.

#+begin_src emacs-lisp :tangle no
(use-package lsp-pyright
  :preface
  (defun nl/pyright-hook ()
    (require 'lsp-pyright)
    (lsp-deferred)
    (python-black-on-save-mode))
  :hook
  (python-ts-mode . nl/pyright-hook))
#+end_src

*** [[https://github.com/wbolster/emacs-python-black][emacs-python-black]]

Using ruff now

#+begin_src emacs-lisp :tangle no
(use-package python-black)
#+end_src


** [[https://github.com/purcell/emacs-reformatter][reformatter]]

Easily define an idiomatic command to reformat the current buffer using a command-line program, together with an optional minor mode which can apply this command automatically on save.

#+begin_src emacs-lisp
(use-package reformatter
  :config
  (reformatter-define java-format
    :program "prettier"
    :args (list "--write" "--parser" "java")
    :lighter " JavaF")
  (reformatter-define sql-format
    :program "prettier"
    :args (list "--write" "--parser" "sql")
    :lighter " SqlF")
  )
#+end_src

** rust

See https://robert.kra.hn/posts/rust-emacs-setup/

#+begin_src emacs-lisp
(defun nl/rustic-mode-hook ()
  (setq-local buffer-save-without-query t
              ;;compilation-ask-about-save nil
              )
  (add-hook 'before-save-hook 'lsp-format-buffer nil t))

(defun nl/toml-mode-hook ()
  (setq-local buffer-save-without-query t
              ;;compilation-ask-about-save nil
              ))

(use-package rustic
  :hook ((rustic-mode . nl/rustic-mode-hook)
         (conf-toml-mode . nl/toml-mode-hook))
  :bind (:map rustic-mode-map
              ("M-j" . lsp-ui-imenu)
              ("M-?" . lsp-find-references)
              ("C-c C-c l" . flycheck-list-errors)
              ("C-c C-c a" . lsp-execute-code-action)
              ("C-c C-c r" . lsp-rename)
              ("C-c C-c q" . lsp-workspace-restart)
              ("C-c C-c Q" . lsp-workspace-shutdown)
              ("C-c C-c s" . lsp-rust-analyzer-status))
  :config
  ;; uncomment for less flashiness
  ;; (setq lsp-eldoc-hook nil)
  ;; (setq lsp-enable-symbol-highlighting nil)
  ;; (setq lsp-signature-auto-activate nil)

  ;; comment to disable rustfmt on save
  (setq rustic-format-on-save t))
#+end_src

** [[https://github.com/Kungsgeten/selected.el][selected]]

Provides the =selected-minor-mode= for Emacs. When =selected-minor-mode= is active, the keybindings in =selected-keymap= will be enabled when the region is active.

#+begin_src emacs-lisp
(use-package selected
  :diminish selected-minor-mode
  ;; :bind (:map selected-keymap
  ;;            ("M-%" . query-replace-regexp)
  ;;            ("C-[" . align-entire)
  ;;            ("C-f" . fill-region)
  ;;            ("C-U" . unfill-region)
  ;;            ("C-d" . downcase-region)
  ;;            ("C-r" . reverse-region)
  ;;            ("C-s" . sort-lines)
  ;;            ("C-u" . upcase-region))
  :init (selected-global-mode 1))
#+end_src

** [[https://github.com/ljos/sparql-mode/tree/15960092e8ce8ebe6a6afd82202ccf47cb306e76][sparql-mode]]

A major mode for emacs that provides syntax highlighting for [[https://www.w3.org/TR/sparql11-query/][SPARQL]].

#+begin_src emacs-lisp
(use-package sparql-mode
  :mode (("\\.rq$" . sparql-mode)))
#+end_src
** [[https://github.com/protesilaos/spacious-padding][spacious-padding]]

#+begin_src emacs-lisp :tangle no
(use-package spacious-padding
  :init
  (setq spacious-padding-widths
        '( :internal-border-width 15
           :header-line-width 4
           :tab-width 4)))

  (spacious-padding-mode 1))
#+end_src

** [[https://github.com/akicho8/string-inflection][string-inflection]]

#+begin_src emacs-lisp
(use-package string-inflection
  :bind (("C-c i" . string-inflection-cycle)
         ("C-c C" . string-inflection-camelcase)        ;; Force to CamelCase
         ("C-c L" . string-inflection-lower-camelcase)  ;; Force to lowerCamelCase
         ("C-c J" . 'string-inflection-java-style-cycle))
  )
#+end_src

** [[https://protesilaos.com/emacs/substitute][substitute]]

Substitute is a set of commands that perform text replacement (i) throughout the buffer, (ii) limited to the
current definition (per narrow-to-defun), (iii) from point to the end of the buffer, and (iv) from point to
the beginning of the buffer.

#+begin_src emacs-lisp
(use-package substitute
  :bind-keymap ("C-c s" . substitute-prefix-map))
#+end_src

** typescript

#+begin_src emacs-lisp
(use-package typescript-ts-mode
  :mode (("\\.ts\\'" . typescript-ts-mode)
         ("\\.js\\'" . typescript-ts-mode)
         ("\\.tsx\\'" . tsx-ts-mode)
         ("\\.jsx\\'" . tsx-ts-mode))
  :bind (:map typescript-ts-mode-map
              ("M-j" . c-indent-new-comment-line))
  :preface
  (use-package nl-typescript :demand :load-path "~/.emacs.d/lisp")
  (use-package nl-react :demand :load-path "~/.emacs.d/lisp")
  (defun nl/typescript-mode ()
    (lsp-deferred)
    (flycheck-mode +1)
    (column-enforce-mode)
    ;;(eldoc-mode +1)
    ;;(company-mode +1)
    (subword-mode +1)
    ;; (push '(">=" . ?≥) prettify-symbols-alist)
    ;; (push '("<=" . ?≤) prettify-symbols-alist)
    ;; (push '("->" . ?→) prettify-symbols-alist)
    ;; (push '("=>" . ?↦) prettify-symbols-alist)
    ;; (prettify-symbols-mode)
    (setq column-enforce-column 120)
    (nl/yas-reload-all))
  :hook
  (typescript-ts-mode . nl/typescript-mode)
  (tsx-ts-mode . nl/typescript-mode)
  :config
  (setq ;;company-tooltip-align-annotations t ;; aligns annotation to the right hand side
        ;;prettify-symbols-unprettify-at-point 'right-edge
        flycheck-check-syntax-automatically '(save mode-enabled))
  (setq-default typescript-indent-level 4)
  )
#+end_src

** [[https://github.com/mhayashi1120/Emacs-wgrep][wgrep]]

You can edit the text in the grep buffer after typing =C-c C-p=. After that the changed text is
highlighted. The following keybindings are defined:

=C-c C-e=: Apply the changes to file buffers.

=C-c C-u=: All changes are unmarked and ignored.

=C-c C-d=: Mark as delete to current line (including newline).

=C-c C-r=: Remove the changes in the region (these changes are not applied to the files. Of course, the remaining changes can still be applied to the files.)

=C-c C-p=: Toggle read-only area.

=C-c C-k=: Discard all changes and exit.

=C-x C-q=: Exit wgrep mode.

To save all buffers that wgrep has changed, run =M-x wgrep-save-all-buffers=.

#+begin_src emacs-lisp
(use-package wgrep
  :demand t)
#+end_src

** [[https://github.com/fxbois/web-mode][web-mode]]

#+begin_src emacs-lisp
(use-package web-mode
  :mode (("\\.html\\'" . web-mode)
         ("\\.css\\'" . web-mode)
         ("\\.tpl.php\\'" . web-mode))
  :preface
  (defun nl/web-mode-hook ()
    (lsp-deferred)
    (prettier-mode)
    (setq web-mode-auto-quote-style 1)
    (local-set-key (kbd "M-q") #'fill-paragraph)) ;; did not work with :bind)
  :hook ((web-mode . nl/web-mode-hook))
  :custom
  (web-mode-auto-quote-style 1)
  (web-mode-code-indent-offset 2)
  (web-mode-markup-indent-offset 2)
  (web-mode-css-indent-offset 2)
  (web-mode-code-indent-offset 4)
  (web-mode-block-padding 4)
  :config
  (add-to-list 'auto-mode-alist '("\\.tpl\\.php\\'" . php-ts-mode))
  )
#+end_src

** [[https://github.com/yoshiki/yaml-mode][yaml-mode]]

#+begin_src emacs-lisp
(use-package yaml-mode
  :mode "\\.\\(yml\\|yaml\\)\\'"
  :preface
  (defun nl/nordita-build-page-from-yaml ()
    "Builds the ProcessWire page for the visited YAML file."
    (interactive)
    (unless (buffer-file-name) (user-error "not a file buffer"))
    (unless (string-match-p "\.yaml$" (buffer-file-name)) (user-error "not a YAML file"))
    (unless (string-match-p "nordita" (buffer-file-name)) (user-error "file is not in a Nordita project"))
    (let* ((default-directory (project-root (project-current)))
           (file-name (nth 1 (split-string buffer-file-name (project-root (project-current)))))
           (base-name (replace-regexp-in-string "\.yaml$" "" (file-name-nondirectory file-name))))
      (unless file-name (user-error "File not in project"))
      (compile
       (format "./docker-wrapper.sh cli pw-page %s build --no-ansi -d -f -i ../default_pages/main_site" base-name))
      ;; (compile
      ;;  (format "cd public && php cli.php pw-page %s build --no-ansi -d -f -i ../default_pages/main_site" base-name))
      ))

  (defhydra hydra-nl-yaml (:color red :hint nil)
    "Project commands"
    ("a" hydra-nl-align/body "align" :color blue :column "General")
    ("y" nl/nordita-build-page-from-yaml "Build ProcessWire page from YAML file" :color blue :column "Nordita"))

  (defun nl/yaml-mode-hook ()
    (set-fill-column 120)
    (display-line-numbers-mode)
    (outline-indent-minor-mode)
    (key-chord-define-local "jc" 'hydra-nl-yaml/body))
  :hook
  (yaml-mode . nl/yaml-mode-hook)
  (yaml-ts-mode . nl/yaml-mode-hook))
#+end_src

** [[https://github.com/capitaomorte/yasnippet][yasnippet]]

It takes a few seconds to load and I don't need them immediately when Emacs starts up, so we can defer loading yasnippet until there's some idle time.

Large collection of snippets: [[https://github.com/AndreaCrotti/yasnippet-snippets][Andrea Crotti's collection]].

#+begin_src emacs-lisp
(use-package yasnippet
  :diminish yas-minor-mode
  :hook (prog-mode . yas-minor-mode)
  :config
  (setq yas-snippet-dirs
      '("~/.emacs.d/snippets"                 ;; personal snippets
        "~/.emacs.d/elpa/yasnippet-snippets-1.0/snippets"
        ))
  (yas-reload-all))
#+end_src

*** [[https://github.com/AndreaCrotti/yasnippet-snippets][yasnippet-snippets]]

See above.

** Org mode

#+begin_src emacs-lisp
(use-package org
  :pin org
  :bind
  ("C-c c" . org-capture)
  :hook
  (org-mode . variable-pitch-mode)
  (org-mode . visual-line-mode)
  ;;(org-mode . nl/org-mode-setup)
  :preface
  (defun nl/org-confirm-babel-evaluate (lang body)
    "Do not confirm evaluation for these languages."
    (not (or (string= lang "bash")
             (string= lang "C")
             (string= lang "emacs-lisp")
             (string= lang "java")
             (string= lang "python")
             (string= lang "sh")
             (string= lang "sql")
             (string= lang "sqlite")
             )))
  :custom-face
  ;;(org-table ((t :foreground "#91b831")))
  (org-block ((t (:inherit fixed-pitch))))
  (org-code ((t (:inherit (shadow fixed-pitch) :height 0.9))))
  (org-verbatim ((t (:inherit (shadow fixed-pitch) :height 1.0))))
  (org-link ((t (:underline t))))
  (org-document-info ((t (:inherit fixed-pitch))))
  (org-document-info-keyword ((t (:inherit fixed-pitch))))
  ;;(org-meta-line ((t (:inherit (font-lock-comment-face fixed-pitch)))))
  (org-meta-line ((t (:inherit fixed-pitch))))
  (org-property-value ((t (:inherit fixed-pitch))) t)
  (org-special-keyword ((t (:inherit (font-lock-comment-face fixed-pitch)))))
  (org-table ((t (:inherit fixed-pitch :height 0.8))))
  (org-tag ((t (:inherit (shadow fixed-pitch) :weight bold :height 0.8))))
  ;; (org-level-1 ((t (:inherit outline-1 :height 2.0))))
  ;; (org-level-2 ((t (:inherit outline-2 :height 1.8))))
  ;; (org-level-3 ((t (:inherit outline-3 :height 1.6))))
  ;; (org-level-4 ((t (:inherit outline-4 :height 1.4))))
  ;; (org-level-5 ((t (:inherit outline-5 :height 1.2))))
  :config
  (setq org-confirm-babel-evaluate 'nl/org-confirm-babel-evaluate
        org-ellipsis " ⤵"
        org-hide-emphasis-markers t
        org-catch-invisible-edits 'error
        org-startup-indented t
        org-cycle-include-plain-lists 'integrate
        org-return-follows-link t
        org-M-RET-may-split-line nil
        org-src-fontify-natively t
        org-src-preserve-indentation t
        org-edit-src-content-indentation 0
        org-enforce-todo-dependencies t
        org-enforce-todo-checkbox-dependencies t
        ;; org-link-frame-setup '((file . find-file))
        org-export-backends '(ascii html icalendar latex md)
        org-log-into-drawer t)

  (setq org-capture-templates
        '(("t" "Todo" entry (file+headline "~/Sync/orgfiles/todo.org" "Tasks")
           "* TODO %?\n  %i\n  %a")
          ("l" "Link" entry (file+headline "~/Sync/orgfiles/links.org" "Links")
           "* %? %^L %^g \n%T" :prepend t)
          ("n" "Note" entry (file "~/Sync/orgfiles/notes.org")
           "* NOTE %?\n%U" :empty-lines 1)
          ("N" "Note with Clipboard" entry (file "~/Sync/orgfiles/notes.org")
           "* NOTE %?\n%U\n   %c" :empty-lines 1)
          ("j" "Journal" entry (file+datetree "~/Sync/orgfiles/journal.org")
           "* %?\nEntered on %U\n  %i\n  %a")))

  (org-babel-do-load-languages
   'org-babel-load-languages
   '((C . t)
     (emacs-lisp . t)
     (latex . t)
     (java . t)
     (js . t)
     (python . t)
     (ruby . t)
     (shell . t)
     (sql . t)
     (sqlite . t)
     ))
  )
#+end_src

*** structure templates

#+begin_src emacs-lisp
(with-eval-after-load 'org
  ;; This is needed as of Org 9.2
  (require 'org-tempo)

  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python")))
#+end_src

*** org-roam

#+begin_src emacs-lisp
(use-package org-roam
  :init
  (setq org-roam-v2-ack t)
  :custom
  (org-roam-db-location "~/Sync/RoamNotes/org-roam.db")
  (org-roam-directory "~/Sync/RoamNotes")
  :bind (("C-c n l" . org-roam-buffer-toggle)
         ("C-c n f" . org-roam-node-find)
         ("C-c n i" . org-roam-node-insert))
  :config
  (org-roam-setup))
#+end_src

* Computer-specific settings

Load some computer-specific settings, such as the name and and email address.

#+begin_src emacs-lisp
(defvar nl/user-settings-dir nil
  "The directory with user-specific Emacs settings for this
  user.")

;; Settings for currently logged in user
(require 's)
(let ((user-dir (concat user-emacs-directory "users")))
  (when (file-directory-p user-dir)
    (setq nl/user-settings-dir
          (concat user-dir "/" (s-trim (shell-command-to-string "hostname -s"))))
    (add-to-list 'load-path nl/user-settings-dir)))

;; Load settings specific for the current user
(when (file-exists-p nl/user-settings-dir)
  (mapc 'load (directory-files nl/user-settings-dir nil "^[^#].*el$")))
#+end_src
